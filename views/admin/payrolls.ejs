<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Payrolls</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/departments.css">
    <style>
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .badge {
            padding: 0.5em 0.75em;
            border-radius: 6px;
            font-weight: 500;
        }

        .badge.bg-success { background-color: var(--success-color) !important; }
        .badge.bg-warning { background-color: var(--warning-color) !important; }
        .badge.bg-danger { background-color: var(--danger-color) !important; }
        .badge.bg-secondary { background-color: var(--secondary-color) !important; }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.75rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(245, 158, 11, 0.25);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .dropdown-menu {
            border-radius: 8px;
            border: none;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .payroll-details {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .earnings-section, .deductions-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success-color);
        }

        .deductions-section {
            border-left-color: var(--danger-color);
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            background: var(--light-bg);
            margin: 0.5rem -1rem -1rem -1rem;
            padding: 0.75rem 1rem;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.2);
        }

        .report-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .report-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .report-description {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .editable-amount {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
        }

        .editable-amount:hover {
            background-color: #f0f9ff;
        }

        .editable-amount i {
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .editable-amount:hover i {
            opacity: 1;
        }

        .inline-edit-form {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .inline-edit-form.active {
            display: flex;
        }

        .inline-edit-input {
            width: 120px;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .btn-inline {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            line-height: 1;
        }

        .earnings-list, .deductions-list {
            margin-bottom: 1rem;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .list-item-content {
            flex-grow: 1;
        }

        .list-item-name {
            font-weight: 500;
            color: #333;
        }

        .list-item-description {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .list-item-amount {
            font-weight: 600;
            margin-right: 1rem;
        }

        .list-item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .add-item-form {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .add-item-form.active {
            border-style: solid;
            border-color: var(--primary-color);
            background: white;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'payrolls' }) %>

    <!-- Main -->
    <div class="main-content" id="mainContent">
        <%- include('./partials/header', { title: 'Payroll Management', user: typeof user !== 'undefined' ? user : { name: 'User' } }) %>

        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4 py-4">
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">
                            <i class="fas fa-users text-primary"></i>
                        </div>
                        <div class="stat-value text-primary" id="totalEmployees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave text-success"></i>
                        </div>
                        <div class="stat-value text-success" id="totalGrossPay">MWK 0</div>
                        <div class="stat-label">Total Gross Pay</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-minus-circle text-warning"></i>
                        </div>
                        <div class="stat-value text-warning" id="totalDeductions">MWK 0</div>
                        <div class="stat-label">Total Deductions</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd text-primary"></i>
                        </div>
                        <div class="stat-value text-primary" id="totalNetPay">MWK 0</div>
                        <div class="stat-label">Total Net Pay</div>
                    </div>
                </div>

                <!-- Actions and Filters -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Payroll Actions & Filters
                            </h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Month Selection -->
                            <div class="col-md-3">
                                <label class="form-label">Select Month</label>
                                <input type="month" class="form-control" id="selectedMonth" 
                                       value="" onchange="loadPayrollData()">
                            </div>
                            
                            <!-- Department Filter -->
                            <div class="col-md-3">
                                <label class="form-label">Department</label>
                                <select class="form-select" id="departmentFilter" onchange="filterPayrolls()">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="col-md-3">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" id="statusFilter" onchange="filterPayrolls()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="processing">Processing</option>
                                    <option value="paid">Paid</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            
                            <!-- Actions -->
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="processPayroll()">
                                        <i class="fas fa-play me-1"></i>
                                        Process Payroll
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons Row -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="btn-toolbar gap-2" role="toolbar">
                                    <button class="btn btn-success btn-sm" onclick="generateConsolidatedPayslips()">
                                        <i class="fas fa-file-pdf me-1"></i>
                                        All Payslips
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="generateBankInstruction()">
                                        <i class="fas fa-university me-1"></i>
                                        Bank Instruction
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="showReportsModal()">
                                        <i class="fas fa-chart-line me-1"></i>
                                        Generate Reports
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="createFromPrevious()">
                                        <i class="fas fa-copy me-1"></i>
                                        Copy Previous Month
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payroll Records Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Payroll Records
                            </h5>
                            <span class="badge bg-info" id="recordCount">0 records</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th>Days Worked</th>
                                        <th>Gross Pay</th>
                                        <th>Deductions</th>
                                        <th>Net Pay</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payrollTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center py-5 text-muted">
                                            <i class="fas fa-search fa-2x mb-3"></i>
                                            <div>Select a month to view payroll records</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Payroll pagination" id="paginationContainer" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>

            </div>
        </main>
    </div>

    <!-- Payroll Details Modal -->
    <div class="modal fade" id="payrollDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>
                        Payroll Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="payrollDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadPayslip()">
                        <i class="fas fa-download me-1"></i>
                        Download Payslip
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div class="modal fade" id="reportsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Generate Reports
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Report Month</label>
                            <input type="month" class="form-control" id="reportMonth">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="">Select Report Type</option>
                                <option value="paye">PAYE Tax Report</option>
                                <option value="pension">Pension Contribution Report</option>
                                <option value="overtime">Overtime Report</option>
                                <option value="loan">Loan Deduction Report</option>
                                <option value="advance">Salary Advance Report</option>
                                <option value="housing">Housing Allowance Report</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card" onclick="generateSpecificReport('paye')">
                            <div class="report-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="report-title">PAYE Tax Report</div>
                            <div class="report-description">Employee income tax deductions and calculations</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('pension')">
                            <div class="report-icon">
                                <i class="fas fa-piggy-bank"></i>
                            </div>
                            <div class="report-title">Pension Report</div>
                            <div class="report-description">Employee pension contributions and rates</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('overtime')">
                            <div class="report-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="report-title">Overtime Report</div>
                            <div class="report-description">Overtime hours, rates, and payments</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('loan')">
                            <div class="report-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="report-title">Loan Report</div>
                            <div class="report-description">Employee loan deductions and balances</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('advance')">
                            <div class="report-icon">
                                <i class="fas fa-money-bill-transfer"></i>
                            </div>
                            <div class="report-title">Advance Report</div>
                            <div class="report-description">Salary advances and repayments</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('housing')">
                            <div class="report-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="report-title">Housing Allowance Report</div>
                            <div class="report-description">Housing allowances by employee and position</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="generateSelectedReport()">
                        <i class="fas fa-download me-1"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Payroll Modal -->
    <div class="modal fade" id="processPayrollModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-play me-2"></i>
                        Process Payroll
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Payroll Month</label>
                        <input type="month" class="form-control" id="processMonth" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will process payroll for all active employees for the selected month.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmProcessPayroll()">
                        <i class="fas fa-play me-1"></i>
                        Process Payroll
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
    
    <script>
        // Global variables
        let currentPayrolls = [];
        let filteredPayrolls = [];
        let currentPage = 1;
        let selectedPayrollId = null;
        
        // Get token from localStorage
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
        }

        // Set up Axios defaults
        axios.defaults.baseURL = '/api';
        axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set current month as default
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            document.getElementById('selectedMonth').value = currentMonth;
            
            // Load initial data
            loadPayrollData();
            loadDepartments();
        });

        // Sidebar functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });

        // Load payroll data for selected month
        async function loadPayrollData() {
            const selectedMonth = document.getElementById('selectedMonth').value;
            if (!selectedMonth) return;

            try {
                showLoading(true);
                
                // Load payroll records
                const response = await axios.get(`/payroll`, {
                    params: { month: selectedMonth, limit: 100 }
                });

                currentPayrolls = response.data.payrolls || [];
                filteredPayrolls = [...currentPayrolls];
                
                displayPayrolls();
                updateStatistics();
                
            } catch (error) {
                console.error('Error loading payroll data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load payroll data'
                });
            } finally {
                showLoading(false);
            }
        }

        // Load departments for filter
        async function loadDepartments() {
            try {
                const response = await axios.get('/departments');
                const departments = response.data.departments || [];
                
                const select = document.getElementById('departmentFilter');
                select.innerHTML = '<option value="">All Departments</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Display payroll records in table
        function displayPayrolls() {
            const tbody = document.getElementById('payrollTableBody');
            const recordCount = document.getElementById('recordCount');
            
            if (filteredPayrolls.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-2x mb-3"></i>
                            <div>No payroll records found</div>
                        </td>
                    </tr>
                `;
                recordCount.textContent = '0 records';
                return;
            }

            recordCount.textContent = `${filteredPayrolls.length} records`;

            tbody.innerHTML = filteredPayrolls.map(payroll => {
                const employee = payroll.employeeId || {};
                const personal = employee.personalInfo || {};
                const employment = employee.employmentInfo || {};
                const department = employment.departmentId || {};
                
                const fullName = `${personal.firstName || ''} ${personal.lastName || ''}`.trim();
                const daysWorked = `${payroll.payPeriod?.daysWorked || 0}/${payroll.payPeriod?.workingDays || 0}`;
                
                const statusBadge = getStatusBadge(payroll.payment?.status || 'pending');
                const approvalStatus = getApprovalStatus(payroll);
                
                return `
                    <tr onclick="viewPayrollDetails('${payroll._id}')" style="cursor: pointer;">
                        <td>
                            <div class="fw-bold">${fullName || 'N/A'}</div>
                            <small class="text-muted">${employee.employeeId || 'N/A'}</small>
                        </td>
                        <td>${department.name || 'N/A'}</td>
                        <td>
                            <span class="badge ${payroll.payPeriod?.daysWorked === payroll.payPeriod?.workingDays ? 'bg-success' : 'bg-warning'}">
                                ${daysWorked}
                            </span>
                        </td>
                        <td class="fw-bold">${payroll.currency || 'MWK'} ${(payroll.grossPay || 0).toLocaleString()}</td>
                        <td class="text-danger">${payroll.currency || 'MWK'} ${(payroll.deductions?.total || 0).toLocaleString()}</td>
                        <td class="fw-bold text-success">${payroll.currency || 'MWK'} ${(payroll.netPay || 0).toLocaleString()}</td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                ${statusBadge}
                                ${approvalStatus}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); viewPayrollDetails('${payroll._id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); downloadPayslip('${payroll._id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { class: 'bg-warning', text: 'Pending' },
                'approved': { class: 'bg-info', text: 'Approved' },
                'processing': { class: 'bg-primary', text: 'Processing' },
                'paid': { class: 'bg-success', text: 'Paid' },
                'failed': { class: 'bg-danger', text: 'Failed' }
            };
            
            const statusInfo = statusMap[status] || { class: 'bg-secondary', text: 'Unknown' };
            return `<span class="badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        // Get approval status
        function getApprovalStatus(payroll) {
            const hr = payroll.approvals?.hr?.status || 'pending';
            const finance = payroll.approvals?.finance?.status || 'pending';
            
            if (hr === 'rejected' || finance === 'rejected') {
                return '<small class="text-danger">Rejected</small>';
            } else if (hr === 'approved' && finance === 'approved') {
                return '<small class="text-success">Fully Approved</small>';
            } else if (hr === 'approved' || finance === 'approved') {
                return '<small class="text-warning">Partially Approved</small>';
            } else {
                return '<small class="text-muted">Pending Approval</small>';
            }
        }

        // Filter payrolls
        function filterPayrolls() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredPayrolls = currentPayrolls.filter(payroll => {
                const matchesDepartment = !departmentFilter || 
                    payroll.employeeId?.employmentInfo?.departmentId?._id === departmentFilter;
                const matchesStatus = !statusFilter || 
                    payroll.payment?.status === statusFilter;
                
                return matchesDepartment && matchesStatus;
            });
            
            displayPayrolls();
        }

        // Update statistics
        function updateStatistics() {
            const totalEmployees = filteredPayrolls.length;
            const totalGross = filteredPayrolls.reduce((sum, p) => sum + (p.grossPay || 0), 0);
            const totalDeductions = filteredPayrolls.reduce((sum, p) => sum + (p.deductions?.total || 0), 0);
            const totalNet = filteredPayrolls.reduce((sum, p) => sum + (p.netPay || 0), 0);
            const currency = filteredPayrolls.length > 0 ? (filteredPayrolls[0].currency || 'MWK') : 'MWK';
            
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalGrossPay').textContent = `${currency} ${totalGross.toLocaleString()}`;
            document.getElementById('totalDeductions').textContent = `${currency} ${totalDeductions.toLocaleString()}`;
            document.getElementById('totalNetPay').textContent = `${currency} ${totalNet.toLocaleString()}`;
        }

        // View payroll details
        async function viewPayrollDetails(payrollId) {
            try {
                selectedPayrollId = payrollId;
                showLoading(true, 'payrollDetailsContent');
                
                const response = await axios.get(`/payroll/${payrollId}`);
                const payroll = response.data;
                
                displayPayrollDetails(payroll);
                
                const modal = new bootstrap.Modal(document.getElementById('payrollDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading payroll details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load payroll details'
                });
            } finally {
                showLoading(false, 'payrollDetailsContent');
            }
        }

        // Display payroll details with inline editing
        function displayPayrollDetails(payroll) {
            const employee = payroll.employeeId || {};
            const personal = employee.personalInfo || {};
            const employment = employee.employmentInfo || {};
            const department = employment.departmentId || {};
            const position = employment.positionId || {};
            const grade = employment.gradeId || {};
            
            const fullName = `${personal.firstName || ''} ${personal.lastName || ''}`.trim();
            
            const content = `
                <div class="row">
                    <!-- Employee Information -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Employee Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6"><strong>Name:</strong></div>
                                    <div class="col-6">${fullName || 'N/A'}</div>
                                    <div class="col-6"><strong>Employee ID:</strong></div>
                                    <div class="col-6">${employee.employeeId || 'N/A'}</div>
                                    <div class="col-6"><strong>Department:</strong></div>
                                    <div class="col-6">${department.name || 'N/A'}</div>
                                    <div class="col-6"><strong>Position:</strong></div>
                                    <div class="col-6">${position.name || 'N/A'}</div>
                                    <div class="col-6"><strong>Grade:</strong></div>
                                    <div class="col-6">${grade.name || 'N/A'} (Level ${grade.level || 'N/A'})</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pay Period Information -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Pay Period</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6"><strong>Month:</strong></div>
                                    <div class="col-6">${payroll.payrollMonth || 'N/A'}</div>
                                    <div class="col-6"><strong>Start Date:</strong></div>
                                    <div class="col-6">${payroll.payPeriod?.startDate ? new Date(payroll.payPeriod.startDate).toLocaleDateString() : 'N/A'}</div>
                                    <div class="col-6"><strong>End Date:</strong></div>
                                    <div class="col-6">${payroll.payPeriod?.endDate ? new Date(payroll.payPeriod.endDate).toLocaleDateString() : 'N/A'}</div>
                                    <div class="col-6"><strong>Working Days:</strong></div>
                                    <div class="col-6">${payroll.payPeriod?.workingDays || 0}</div>
                                    <div class="col-6"><strong>Days Worked:</strong></div>
                                    <div class="col-6">${payroll.payPeriod?.daysWorked || 0}</div>
                                    <div class="col-6"><strong>Attendance:</strong></div>
                                    <div class="col-6">
                                        <span class="badge ${payroll.attendanceRate >= 90 ? 'bg-success' : payroll.attendanceRate >= 75 ? 'bg-warning' : 'bg-danger'}">
                                            ${payroll.attendanceRate || 0}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Earnings Section -->
                    <div class="col-md-6">
                        <div class="earnings-section">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-plus-circle me-2"></i>
                                Earnings Breakdown
                            </h6>
                            
                            <div class="earnings-list">
                                <!-- Basic Salary -->
                                <div class="list-item">
                                    <div class="list-item-content">
                                        <div class="list-item-name">Basic Salary</div>
                                    </div>
                                    <div class="list-item-amount" id="salary-base-display">
                                        ${payroll.currency || 'MWK'} ${(payroll.salary?.base || 0).toLocaleString()}
                                    </div>
                                    <div class="list-item-actions">
                                        <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('salary.base', ${payroll.salary?.base || 0}, 'salary-base')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Prorated Salary -->
                                <div class="list-item">
                                    <div class="list-item-content">
                                        <div class="list-item-name">Prorated Salary</div>
                                    </div>
                                    <div class="list-item-amount" id="salary-prorated-display">
                                        ${payroll.currency || 'MWK'} ${(payroll.salary?.prorated || 0).toLocaleString()}
                                    </div>
                                    <div class="list-item-actions">
                                        <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('salary.prorated', ${payroll.salary?.prorated || 0}, 'salary-prorated')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>

                                ${generateAllowanceItems(payroll)}
                                ${generateOvertimeItem(payroll)}
                                ${generateBonusItems(payroll)}
                            </div>

                            <!-- Add Custom Earning Form -->
                            <div class="add-item-form" id="add-earning-form">
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control form-control-sm" id="new-earning-name" placeholder="Earning name">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control form-control-sm" id="new-earning-amount" placeholder="Amount" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="btn-group w-100">
                                            <button class="btn btn-sm btn-success" onclick="addCustomEarning()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-sm btn-secondary" onclick="toggleAddEarningForm()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2">
                                <button class="btn btn-sm btn-success" onclick="toggleAddEarningForm()">
                                    <i class="fas fa-plus me-1"></i>
                                    Add Custom Earning
                                </button>
                            </div>

                            <div class="list-item mt-3" style="background: #e8f5e8; font-weight: bold;">
                                <div class="list-item-content">
                                    <div class="list-item-name text-success">GROSS PAY</div>
                                </div>
                                <div class="list-item-amount text-success">
                                    ${payroll.currency || 'MWK'} ${(payroll.grossPay || 0).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deductions Section -->
                    <div class="col-md-6">
                        <div class="deductions-section">
                            <h6 class="text-danger mb-3">
                                <i class="fas fa-minus-circle me-2"></i>
                                Deductions Breakdown
                            </h6>
                            
                            <div class="deductions-list">
                                ${generateTaxItem(payroll)}
                                ${generatePensionItem(payroll)}
                                ${generateLoanItems(payroll)}
                                ${generateOtherDeductionItems(payroll)}
                            </div>

                            <!-- Add Custom Deduction Form -->
                            <div class="add-item-form" id="add-deduction-form">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control form-control-sm" id="new-deduction-name" placeholder="Deduction name">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control form-control-sm" id="new-deduction-amount" placeholder="Amount" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" id="new-deduction-desc" placeholder="Description">
                                    </div>
                                    <div class="col-md-2">
                                        <div class="btn-group w-100">
                                            <button class="btn btn-sm btn-danger" onclick="addCustomDeduction()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-sm btn-secondary" onclick="toggleAddDeductionForm()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-2">
                                <button class="btn btn-sm btn-danger" onclick="toggleAddDeductionForm()">
                                    <i class="fas fa-plus me-1"></i>
                                    Add Custom Deduction
                                </button>
                            </div>

                            <div class="list-item mt-3" style="background: #fee; font-weight: bold;">
                                <div class="list-item-content">
                                    <div class="list-item-name text-danger">TOTAL DEDUCTIONS</div>
                                </div>
                                <div class="list-item-amount text-danger">
                                    ${payroll.currency || 'MWK'} ${(payroll.deductions?.total || 0).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Net Pay -->
                <div class="row">
                    <div class="col-12">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4 class="mb-0">
                                    <i class="fas fa-hand-holding-usd me-2"></i>
                                    NET PAY: ${payroll.currency || 'MWK'} ${(payroll.netPay || 0).toLocaleString()}
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment and Approval Information -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6"><strong>Status:</strong></div>
                                    <div class="col-6">${getStatusBadge(payroll.payment?.status || 'pending')}</div>
                                    <div class="col-6"><strong>Method:</strong></div>
                                    <div class="col-6">${payroll.payment?.method || 'Bank Transfer'}</div>
                                    <div class="col-6"><strong>Reference:</strong></div>
                                    <div class="col-6">${payroll.payment?.reference || 'N/A'}</div>
                                    <div class="col-6"><strong>Paid At:</strong></div>
                                    <div class="col-6">${payroll.payment?.paidAt ? new Date(payroll.payment.paidAt).toLocaleDateString() : 'Not Paid'}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Approval Information -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Approval Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6"><strong>HR Approval:</strong></div>
                                    <div class="col-6">${getStatusBadge(payroll.approvals?.hr?.status || 'pending')}</div>
                                    <div class="col-6"><strong>Finance Approval:</strong></div>
                                    <div class="col-6">${getStatusBadge(payroll.approvals?.finance?.status || 'pending')}</div>
                                    ${payroll.approvals?.hr?.at ? `
                                    <div class="col-6"><strong>HR Approved At:</strong></div>
                                    <div class="col-6">${new Date(payroll.approvals.hr.at).toLocaleDateString()}</div>` : ''}
                                    ${payroll.approvals?.finance?.at ? `
                                    <div class="col-6"><strong>Finance Approved At:</strong></div>
                                    <div class="col-6">${new Date(payroll.approvals.finance.at).toLocaleDateString()}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${generateAdjustmentsSection(payroll)}
            `;
            
            document.getElementById('payrollDetailsContent').innerHTML = content;
            
            // Hide add forms initially
            document.getElementById('add-earning-form').style.display = 'none';
            document.getElementById('add-deduction-form').style.display = 'none';
        }

        // Generate allowance items
        function generateAllowanceItems(payroll) {
            const allowances = payroll.allowances || {};
            const currency = payroll.currency || 'MWK';
            let html = '';
            
            const allowanceTypes = [
                { key: 'transport', label: 'Transport Allowance' },
                { key: 'housing', label: 'Housing Allowance' },
                { key: 'medical', label: 'Medical Allowance' },
                { key: 'meals', label: 'Meal Allowance' },
                { key: 'communication', label: 'Communication Allowance' },
                { key: 'other', label: 'Other Allowances' }
            ];
            
            allowanceTypes.forEach(type => {
                if (allowances[type.key] > 0) {
                    html += `
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-name">${type.label}</div>
                            </div>
                            <div class="list-item-amount" id="allowances-${type.key}-display">
                                ${currency} ${allowances[type.key].toLocaleString()}
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('allowances.${type.key}', ${allowances[type.key]}, 'allowances-${type.key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        // Generate overtime item
        function generateOvertimeItem(payroll) {
            if (!payroll.overtime?.amount || payroll.overtime.amount <= 0) return '';
            
            const currency = payroll.currency || 'MWK';
            return `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-name">Overtime</div>
                        <div class="list-item-description">${payroll.overtime.hours}h @ ${currency} ${payroll.overtime.rate}</div>
                    </div>
                    <div class="list-item-amount" id="overtime-amount-display">
                        ${currency} ${payroll.overtime.amount.toLocaleString()}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('overtime.amount', ${payroll.overtime.amount}, 'overtime-amount')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Generate bonus items
        function generateBonusItems(payroll) {
            const bonuses = payroll.bonuses || {};
            const currency = payroll.currency || 'MWK';
            let html = '';
            
            const bonusTypes = [
                { key: 'performance', label: 'Performance Bonus' },
                { key: 'annual', label: 'Annual Bonus' },
                { key: 'other', label: 'Other Bonuses' }
            ];
            
            bonusTypes.forEach(type => {
                if (bonuses[type.key] > 0) {
                    html += `
                        <div class="list-item">
                            <div class="list-item-content">
                                <div class="list-item-name">${type.label}</div>
                            </div>
                            <div class="list-item-amount" id="bonuses-${type.key}-display">
                                ${currency} ${bonuses[type.key].toLocaleString()}
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('bonuses.${type.key}', ${bonuses[type.key]}, 'bonuses-${type.key}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            return html;
        }

        // Generate tax item
        function generateTaxItem(payroll) {
            if (!payroll.deductions?.tax?.amount || payroll.deductions.tax.amount <= 0) return '';
            
            const currency = payroll.currency || 'MWK';
            return `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-name">PAYE Tax</div>
                        <div class="list-item-description">Rate: ${payroll.deductions.tax.rate}%</div>
                    </div>
                    <div class="list-item-amount" id="tax-rate-display">
                        ${currency} ${payroll.deductions.tax.amount.toLocaleString()}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('deductions.tax.rate', ${payroll.deductions.tax.rate}, 'tax-rate')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Generate pension item
        function generatePensionItem(payroll) {
            if (!payroll.deductions?.pension?.amount || payroll.deductions.pension.amount <= 0) return '';
            
            const currency = payroll.currency || 'MWK';
            return `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-name">Pension</div>
                        <div class="list-item-description">Rate: ${payroll.deductions.pension.rate}%</div>
                    </div>
                    <div class="list-item-amount" id="pension-rate-display">
                        ${currency} ${payroll.deductions.pension.amount.toLocaleString()}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-outline-primary btn-inline" onclick="editInline('deductions.pension.rate', ${payroll.deductions.pension.rate}, 'pension-rate')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Generate loan items
        function generateLoanItems(payroll) {
            if (!payroll.deductions?.loans || payroll.deductions.loans.length === 0) return '';
            
            const currency = payroll.currency || 'MWK';
            return payroll.deductions.loans.map((loan, index) => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-name">Loan: ${loan.description || 'Loan'}</div>
                    </div>
                    <div class="list-item-amount">
                        ${currency} ${loan.amount.toLocaleString()}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-outline-danger btn-inline" onclick="removeLoanDeduction(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Generate other deduction items
        function generateOtherDeductionItems(payroll) {
            if (!payroll.deductions?.other || payroll.deductions.other.length === 0) return '';
            console.log('Generating other deductions:', payroll.deductions.other);
            
            const currency = payroll.currency || 'MWK';
            return payroll.deductions.other.map((item, index) => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="list-item-name">${item.name || item.description || 'Deduction'}</div>
                        ${item.description ? `<div class="list-item-description">${item.description}</div>` : ''}
                    </div>
                    <div class="list-item-amount">
                        ${currency} ${item.amount.toLocaleString()}
                    </div>
                    <div class="list-item-actions">
                        <button class="btn btn-sm btn-outline-danger btn-inline" onclick="removeCustomDeduction(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Generate adjustments section
        function generateAdjustmentsSection(payroll) {
            if (!payroll.adjustments || payroll.adjustments.length === 0) return '';
            
            return `
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Adjustments History</h6>
                            </div>
                            <div class="card-body">
                                ${payroll.adjustments.map(adj => `
                                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                                        <div>
                                            <strong>${adj.reason}</strong>
                                            <br>
                                            <small class="text-muted">${adj.category} - ${adj.type}</small>
                                            ${adj.duration === 'permanent' ? `
                                                <br>
                                                <small class="text-info">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    Permanent (${adj.durationDetails?.numberOfMonths || 0} months)
                                                </small>
                                            ` : `
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    Temporary
                                                </small>
                                            `}
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold ${adj.type === 'addition' ? 'text-success' : 'text-danger'}">
                                                ${adj.type === 'addition' ? '+' : '-'}${payroll.currency || 'MWK'} ${Math.abs(adj.amount).toLocaleString()}
                                            </span>
                                            <br>
                                            <small class="text-muted">${adj.appliedAt ? new Date(adj.appliedAt).toLocaleDateString() : 'N/A'}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle add earning form
        function toggleAddEarningForm() {
            const form = document.getElementById('add-earning-form');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
                form.classList.remove('active');
                // Clear form
                document.getElementById('new-earning-name').value = '';
                document.getElementById('new-earning-amount').value = '';
            } else {
                form.style.display = 'block';
                form.classList.add('active');
                document.getElementById('new-earning-name').focus();
            }
        }

        // Toggle add deduction form
        function toggleAddDeductionForm() {
            const form = document.getElementById('add-deduction-form');
            const isVisible = form.style.display !== 'none';
            
            if (isVisible) {
                form.style.display = 'none';
                form.classList.remove('active');
                // Clear form
                document.getElementById('new-deduction-name').value = '';
                document.getElementById('new-deduction-amount').value = '';
                document.getElementById('new-deduction-desc').value = '';
            } else {
                form.style.display = 'block';
                form.classList.add('active');
                document.getElementById('new-deduction-name').focus();
            }
        }

        // Edit inline functionality
        function editInline(fieldPath, currentValue, elementId) {
            const displayElement = document.getElementById(`${elementId}-display`);
            if (!displayElement) return;

            // Create inline edit form
            const currency = getCurrentCurrency();
            const editForm = document.createElement('div');
            editForm.className = 'inline-edit-form active d-flex align-items-center gap-2';
            editForm.innerHTML = `
                <input type="number" class="inline-edit-input" value="${currentValue}" step="0.01" min="0" id="${elementId}-input">
                <button class="btn btn-sm btn-success btn-inline" onclick="saveInlineEdit('${fieldPath}', '${elementId}')">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-sm btn-secondary btn-inline" onclick="cancelInlineEdit('${elementId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Store original content
            displayElement.dataset.originalContent = displayElement.innerHTML;
            
            // Replace display with edit form
            displayElement.innerHTML = '';
            displayElement.appendChild(editForm);
            
            // Focus input and select text
            const input = document.getElementById(`${elementId}-input`);
            input.focus();
            input.select();
        }

        // Save inline edit
        async function saveInlineEdit(fieldPath, elementId) {
            const input = document.getElementById(`${elementId}-input`);
            const newValue = parseFloat(input.value);
            
            if (isNaN(newValue) || newValue < 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Value',
                    text: 'Please enter a valid positive number'
                });
                return;
            }

            try {
                showLoading(true);
                
                await axios.patch(`/payroll/${selectedPayrollId}/field`, {
                    fieldPath: fieldPath,
                    value: newValue
                });

                // Success message
                Swal.fire({
                    icon: 'success',
                    title: 'Updated',
                    text: 'Field updated successfully',
                    timer: 1500,
                    showConfirmButton: false
                });

                // Reload payroll details
                await viewPayrollDetails(selectedPayrollId);

            } catch (error) {
                console.error('Error updating field:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to update field'
                });
                
                // Restore original content on error
                cancelInlineEdit(elementId);
            } finally {
                showLoading(false);
            }
        }

        // Cancel inline edit
        function cancelInlineEdit(elementId) {
            const displayElement = document.getElementById(`${elementId}-display`);
            if (!displayElement || !displayElement.dataset.originalContent) return;
            
            displayElement.innerHTML = displayElement.dataset.originalContent;
            delete displayElement.dataset.originalContent;
        }

        // Add custom earning
        async function addCustomEarning() {
            const name = document.getElementById('new-earning-name').value.trim();
            const amount = parseFloat(document.getElementById('new-earning-amount').value);
            
            if (!name) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Information',
                    text: 'Please enter an earning name'
                });
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Invalid Amount',
                    text: 'Please enter a valid amount greater than 0'
                });
                return;
            }

            try {
                showLoading(true);
                
                await axios.post(`/payroll/${selectedPayrollId}/earnings/custom`, {
                    name: name,
                    amount: amount
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Custom earning added successfully',
                    timer: 1500,
                    showConfirmButton: false
                });

                // Hide form and reload details
                toggleAddEarningForm();
                await viewPayrollDetails(selectedPayrollId);

            } catch (error) {
                console.error('Error adding custom earning:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to add custom earning'
                });
            } finally {
                showLoading(false);
            }
        }

        // Add custom deduction
        async function addCustomDeduction() {
            const name = document.getElementById('new-deduction-name').value.trim();
            const amount = parseFloat(document.getElementById('new-deduction-amount').value);
            const description = document.getElementById('new-deduction-desc').value.trim();
            
            if (!name) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Information',
                    text: 'Please enter a deduction name'
                });
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Invalid Amount',
                    text: 'Please enter a valid amount greater than 0'
                });
                return;
            }

            try {
                showLoading(true);
                
                await axios.post(`/payroll/${selectedPayrollId}/deductions/custom`, {
                    name: name,
                    amount: amount,
                    description: description
                });

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Custom deduction added successfully',
                    timer: 1500,
                    showConfirmButton: false
                });

                // Hide form and reload details
                toggleAddDeductionForm();
                await viewPayrollDetails(selectedPayrollId);

            } catch (error) {
                console.error('Error adding custom deduction:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to add custom deduction'
                });
            } finally {
                showLoading(false);
            }
        }

        // Remove custom deduction
        async function removeCustomDeduction(deductionIndex) {
            try {
                const result = await Swal.fire({
                    title: 'Remove Deduction',
                    text: 'Are you sure you want to remove this deduction?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, remove it!',
                    cancelButtonText: 'Cancel'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    await axios.delete(`/payroll/${selectedPayrollId}/deductions/custom/${deductionIndex}`);

                    Swal.fire({
                        icon: 'success',
                        title: 'Removed',
                        text: 'Deduction removed successfully',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    await viewPayrollDetails(selectedPayrollId);
                }
            } catch (error) {
                console.error('Error removing deduction:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to remove deduction'
                });
            } finally {
                showLoading(false);
            }
        }

        // Remove loan deduction
        async function removeLoanDeduction(loanIndex) {
            try {
                const result = await Swal.fire({
                    title: 'Remove Loan Deduction',
                    text: 'Are you sure you want to remove this loan deduction?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, remove it!',
                    cancelButtonText: 'Cancel'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    // This would need a separate endpoint for loan deductions
                    await axios.delete(`/payroll/${selectedPayrollId}/deductions/loans/${loanIndex}`);

                    Swal.fire({
                        icon: 'success',
                        title: 'Removed',
                        text: 'Loan deduction removed successfully',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    await viewPayrollDetails(selectedPayrollId);
                }
            } catch (error) {
                console.error('Error removing loan deduction:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to remove loan deduction'
                });
            } finally {
                showLoading(false);
            }
        }

        // Get current currency
        function getCurrentCurrency() {
            return filteredPayrolls.length > 0 ? (filteredPayrolls[0].currency || 'MWK') : 'MWK';
        }

        // Download individual payslip
        async function downloadPayslip(payrollId = null) {
            const id = payrollId || selectedPayrollId;
            if (!id) return;

            try {
                const response = await axios.get(`/payroll/${id}/payslip`, {
                    params: { download: true },
                    responseType: 'blob'
                });

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `payslip_${id}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Payslip downloaded successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error downloading payslip:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to download payslip'
                });
            }
        }

        // Process payroll for all employees
        function processPayroll() {
            const selectedMonth = document.getElementById('selectedMonth').value;
            if (!selectedMonth) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            document.getElementById('processMonth').value = selectedMonth;
            const modal = new bootstrap.Modal(document.getElementById('processPayrollModal'));
            modal.show();
        }

        // Confirm payroll processing
        async function confirmProcessPayroll() {
            const month = document.getElementById('processMonth').value;
            if (!month) return;

            try {
                const result = await Swal.fire({
                    title: 'Confirm Payroll Processing',
                    text: `Process payroll for all active employees for ${month}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    confirmButtonText: 'Yes, Process!'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    const response = await axios.post('/payroll/process', { month });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: `Processed payroll for ${response.data.processedCount} employees`
                    });

                    // Close modal and reload data
                    bootstrap.Modal.getInstance(document.getElementById('processPayrollModal')).hide();
                    loadPayrollData();
                }
            } catch (error) {
                console.error('Error processing payroll:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to process payroll'
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate consolidated payslips
        async function generateConsolidatedPayslips() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                showLoading(true);

                const response = await axios.get(`/payroll/consolidated-payslips/${month}`, {
                    responseType: 'blob'
                });

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `consolidated_payslips_${month}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Consolidated payslips generated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error generating consolidated payslips:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to generate consolidated payslips'
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate bank instruction
        async function generateBankInstruction() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                showLoading(true);
                
                const response = await axios.post('/payroll/bank-instruction', 
                    { month }, 
                    { responseType: 'blob' }
                );

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `bank_instruction_${month}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Bank instruction generated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error generating bank instruction:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to generate bank instruction'
                });
            } finally {
                showLoading(false);
            }
        }

        // Show reports modal
        function showReportsModal() {
            const month = document.getElementById('selectedMonth').value;
            if (month) {
                document.getElementById('reportMonth').value = month;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('reportsModal'));
            modal.show();
        }

        // Generate specific report from report card click
        async function generateSpecificReport(reportType) {
            const month = document.getElementById('reportMonth').value || document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                showLoading(true);
                
                const response = await axios.post(`/payroll/report/${reportType}`, 
                    { month }, 
                    { responseType: 'blob' }
                );

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${reportType}_report_${month}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('reportsModal')).hide();

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: `${reportType.toUpperCase()} report generated successfully`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error generating report:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Failed to generate ${reportType.toUpperCase()} report`
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate selected report from dropdown
        async function generateSelectedReport() {
            const reportType = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').value;
            
            if (!reportType) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a report type'
                });
                return;
            }
            
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month'
                });
                return;
            }

            await generateSpecificReport(reportType);
        }

        // Create payroll from previous month
        async function createFromPrevious() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                const result = await Swal.fire({
                    title: 'Create from Previous Month',
                    text: `Create payroll records for ${month} using previous month's data?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    confirmButtonText: 'Yes, Create!'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    const response = await axios.post('/payroll/create-from-previous', { month });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: `Created payroll for ${response.data.processedCount} employees from previous month`
                    });

                    loadPayrollData();
                }
            } catch (error) {
                console.error('Error creating from previous month:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to create payroll from previous month'
                });
            } finally {
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show, targetId = null) {
            if (targetId) {
                const target = document.getElementById(targetId);
                if (show) {
                    target.innerHTML = `
                        <div class="text-center py-5">
                            <div class="loading-spinner mb-3"></div>
                            <div>Loading...</div>
                        </div>
                    `;
                }
            } else {
                // Show global loading
                if (show) {
                    Swal.fire({
                        title: 'Processing...',
                        html: '<div class="loading-spinner"></div>',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false
                    });
                } else {
                    Swal.close();
                }
            }
        }

        // Utility function to format currency
        function formatCurrency(amount, currency = 'MWK') {
            return `${currency} ${(amount || 0).toLocaleString()}`;
        }

        // Utility function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }
    </script>
    <script src="/js/admin.js"></script>
</body>
</html>