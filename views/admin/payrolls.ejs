<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Payrolls</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        /* Enhanced Professional Styling */
        .payroll-status-badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payroll-status-badge.status-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .payroll-status-badge.status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .payroll-status-badge.status-approved {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .payroll-status-badge.status-processing {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .payroll-status-badge.status-failed {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .detail-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .detail-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .detail-section-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .detail-section-icon.icon-employee {
            background: rgba(108, 12, 13, 0.1);
            color: var(--sidebar-dark-blue);
        }

        .detail-section-icon.icon-period {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .detail-section-icon.icon-earnings {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .detail-section-icon.icon-deductions {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 1rem;
            padding: 0.75rem 0;
            align-items: start;
        }

        .detail-row:not(:last-child) {
            border-bottom: 1px solid #f1f5f9;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .detail-value {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .amount-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .amount-breakdown-item:hover {
            background: #f1f5f9;
            transform: translateX(4px);
        }

        .amount-breakdown-item.item-primary {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left-color: var(--golden-yellow);
        }

        .amount-breakdown-item.item-success {
            border-left-color: #10b981;
        }

        .amount-breakdown-item.item-danger {
            border-left-color: #ef4444;
        }

        .amount-breakdown-item.item-total {
            background: linear-gradient(135deg, #e8f5e8 0%, #d1f0d1 100%);
            border: 2px solid #10b981;
            font-weight: 700;
            margin-top: 1rem;
            padding: 1.25rem 1rem;
        }

        .amount-breakdown-item.item-total-deductions {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            font-weight: 700;
            margin-top: 1rem;
            padding: 1.25rem 1rem;
        }

        .amount-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .amount-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .amount-value {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-primary);
        }

        .amount-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .net-pay-card {
            background: linear-gradient(135deg, var(--sidebar-dark-blue) 0%, #8b0e0f 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(108, 12, 13, 0.3);
        }

        .net-pay-label {
            font-size: 0.95rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .net-pay-amount {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .adjustments-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .adjustments-timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--golden-yellow), transparent);
        }

        .adjustment-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .adjustment-item::before {
            content: '';
            position: absolute;
            left: -1.4rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--golden-yellow);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--golden-yellow);
        }

        .adjustment-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }

        .adjustment-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .adjustment-reason {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .adjustment-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .adjustment-amount.positive {
            color: #10b981;
        }

        .adjustment-amount.negative {
            color: #ef4444;
        }

        .adjustment-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .adjustment-meta-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .paid-lock-notice {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .paid-lock-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .paid-lock-content h5 {
            color: #065f46;
            font-weight: 700;
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }

        .paid-lock-content p {
            color: #047857;
            margin: 0;
            font-size: 0.9rem;
        }

        .approval-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .approval-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .approval-card.approved {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, white 100%);
        }

        .approval-card.pending {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, white 100%);
        }

        .approval-card.rejected {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, white 100%);
        }

        .approval-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .approval-card.approved .approval-icon {
            background: #10b981;
            color: white;
        }

        .approval-card.pending .approval-icon {
            background: #f59e0b;
            color: white;
        }

        .approval-card.rejected .approval-icon {
            background: #ef4444;
            color: white;
        }

        .approval-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .approval-by {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .approval-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Responsive table styling */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(248, 195, 183, 0.2);
        }

        .employee-name-cell {
            font-weight: 600;
            color: var(--text-primary);
        }

        .employee-id-cell {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .action-btn-group {
            display: flex;
            gap: 0.25rem;
        }

        /* Stats cards enhancement */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(248, 195, 183, 0.2) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        /* Filter card enhancement */
        .filter-card-header {
            background: linear-gradient(135deg, var(--sidebar-dark-blue) 0%, #8b0e0f 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.25rem 1.5rem;
        }

        .filter-card-header h5 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Enhanced modal styling */
        .modal-content {
            border-radius: 16px;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--sidebar-dark-blue) 0%, #8b0e0f 100%);
            color: white;
            padding: 1.5rem 2rem;
            border: none;
        }

        .modal-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-close-white {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            background: #f8fafc;
            border-top: 2px solid var(--border-color);
            padding: 1.25rem 2rem;
        }

        /* Loading states */
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Print styles */
        @media print {
            .sidebar, .top-header, .filter-card, .action-btn-group, .modal-footer {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .detail-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'payrolls' }) %>

    <!-- Main -->
    <div class="main-content" id="mainContent">
        <%- include('./partials/header', { title: 'Payroll Management', user: typeof user !== 'undefined' ? user : { name: 'User' } }) %>

        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4 py-4">
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Employees</div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-trend">
                            <i class="fas fa-chart-line"></i>
                            <span>Active payroll records</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Gross Pay</div>
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalGrossPay">MWK 0</div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>Before deductions</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Deductions</div>
                            <div class="stat-icon">
                                <i class="fas fa-minus-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalDeductions">MWK 0</div>
                        <div class="stat-trend">
                            <i class="fas fa-arrow-down"></i>
                            <span>Taxes & contributions</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Net Pay</div>
                            <div class="stat-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalNetPay">MWK 0</div>
                        <div class="stat-trend">
                            <i class="fas fa-check-circle"></i>
                            <span>Final disbursement</span>
                        </div>
                    </div>
                </div>

                <!-- Filters & Actions Card -->
                <div class="card mb-4">
                    <div class="filter-card-header">
                        <h5>
                            <i class="fas fa-filter"></i>
                            Filters & Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-calendar-alt me-2"></i>Payroll Month
                                </label>
                                <input type="month" class="form-control" id="selectedMonth" 
                                       value="" onchange="loadPayrollData()">
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-building me-2"></i>Department
                                </label>
                                <select class="form-select" id="departmentFilter" onchange="filterPayrolls()">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-flag me-2"></i>Payment Status
                                </label>
                                <select class="form-select" id="statusFilter" onchange="filterPayrolls()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="processing">Processing</option>
                                    <option value="paid">Paid</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2 pt-3 border-top">
                            <button class="btn btn-success" onclick="generateConsolidatedPayslips()">
                                <i class="fas fa-file-pdf me-2"></i>All Payslips
                            </button>
                            <button class="btn btn-info" onclick="generateBankInstruction()">
                                <i class="fas fa-university me-2"></i>Bank Instruction
                            </button>
                            <button class="btn btn-warning" onclick="showReportsModal()">
                                <i class="fas fa-chart-line me-2"></i>Generate Reports
                            </button>
                            <button class="btn btn-outline-primary" onclick="createFromPrevious()">
                                <i class="fas fa-copy me-2"></i>Copy Previous Month
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Payroll Records Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Payroll Records
                            </h5>
                            <span class="badge bg-info" id="recordCount">0 records</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th>Days Worked</th>
                                        <th>Gross Pay</th>
                                        <th>Deductions</th>
                                        <th>Net Pay</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payrollTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center py-5 text-muted">
                                            <i class="fas fa-search fa-3x mb-3 d-block"></i>
                                            <div class="fs-5">Select a month to view payroll records</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav aria-label="Payroll pagination" id="paginationContainer" style="display: none;">
                    <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
                </nav>

            </div>
        </main>
    </div>

    <!-- Payroll Details Modal -->
    <div class="modal fade" id="payrollDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt"></i>
                        Payroll Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="payrollDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadPayslip()">
                        <i class="fas fa-download me-2"></i>Download Payslip
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div class="modal fade" id="reportsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line"></i>
                        Generate Reports
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Report Month</label>
                            <input type="month" class="form-control" id="reportMonth">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="">Select Report Type</option>
                                <option value="paye">PAYE Tax Report</option>
                                <option value="pension">Pension Contribution Report</option>
                                <option value="overtime">Overtime Report</option>
                                <option value="loan">Loan Deduction Report</option>
                                <option value="advance">Salary Advance Report</option>
                                <option value="housing">Housing Allowance Report</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card" onclick="generateSpecificReport('paye')">
                            <div class="report-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="report-title">PAYE Tax Report</div>
                            <div class="report-description">Employee income tax deductions and calculations</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('pension')">
                            <div class="report-icon">
                                <i class="fas fa-piggy-bank"></i>
                            </div>
                            <div class="report-title">Pension Report</div>
                            <div class="report-description">Employee pension contributions and rates</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('overtime')">
                            <div class="report-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="report-title">Overtime Report</div>
                            <div class="report-description">Overtime hours, rates, and payments</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('loan')">
                            <div class="report-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="report-title">Loan Report</div>
                            <div class="report-description">Employee loan deductions and balances</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('advance')">
                            <div class="report-icon">
                                <i class="fas fa-money-bill-transfer"></i>
                            </div>
                            <div class="report-title">Advance Report</div>
                            <div class="report-description">Salary advances and repayments</div>
                        </div>
                        
                        <div class="report-card" onclick="generateSpecificReport('housing')">
                            <div class="report-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="report-title">Housing Allowance Report</div>
                            <div class="report-description">Housing allowances by employee and position</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="generateSelectedReport()">
                        <i class="fas fa-download me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Payroll Modal -->
    <div class="modal fade" id="processPayrollModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-play"></i>
                        Process Payroll
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Payroll Month</label>
                        <input type="month" class="form-control" id="processMonth" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will process payroll for all active employees for the selected month.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmProcessPayroll()">
                        <i class="fas fa-play me-2"></i>Process Payroll
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
    
    <script>
        // Global variables
        let currentPayrolls = [];
        let filteredPayrolls = [];
        let currentPage = 1;
        let selectedPayrollId = null;
        
        // Get token from localStorage
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
        }

        // Set up Axios defaults
        axios.defaults.baseURL = '/api';
        axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            document.getElementById('selectedMonth').value = currentMonth;
            
            loadPayrollData();
            loadDepartments();
        });

        // Sidebar functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
            });
        }

        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('show');
                this.classList.remove('show');
            });
        }

        // Load payroll data for selected month
        async function loadPayrollData() {
            const selectedMonth = document.getElementById('selectedMonth').value;
            if (!selectedMonth) return;

            try {
                showLoading(true);
                
                const response = await axios.get(`/payroll`, {
                    params: { month: selectedMonth, limit: 100 }
                });

                currentPayrolls = response.data.payrolls || [];
                filteredPayrolls = [...currentPayrolls];
                
                displayPayrolls();
                updateStatistics();
                
            } catch (error) {
                console.error('Error loading payroll data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load payroll data'
                });
            } finally {
                showLoading(false);
            }
        }

        // Load departments for filter
        async function loadDepartments() {
            try {
                const response = await axios.get('/departments');
                const departments = response.data.departments || [];
                
                const select = document.getElementById('departmentFilter');
                select.innerHTML = '<option value="">All Departments</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept._id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Display payroll records in table
        function displayPayrolls() {
            const tbody = document.getElementById('payrollTableBody');
            const recordCount = document.getElementById('recordCount');
            
            if (filteredPayrolls.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            <div class="fs-5">No payroll records found</div>
                        </td>
                    </tr>
                `;
                recordCount.textContent = '0 records';
                return;
            }

            recordCount.textContent = `${filteredPayrolls.length} records`;

            tbody.innerHTML = filteredPayrolls.map(payroll => {
                const employee = payroll.employeeId || {};
                const personal = employee.personalInfo || {};
                const employment = employee.employmentInfo || {};
                const department = employment.departmentId || {};
                
                const fullName = `${personal.firstName || ''} ${personal.lastName || ''}`.trim();
                const daysWorked = `${payroll.payPeriod?.daysWorked || 0}/${payroll.payPeriod?.workingDays || 0}`;
                
                const statusBadge = getStatusBadge(payroll.payment?.status || 'pending');
                const approvalStatus = getApprovalStatus(payroll);
                
                return `
                    <tr onclick="viewPayrollDetails('${payroll._id}')" style="cursor: pointer;">
                        <td>
                            <div class="employee-name-cell">${fullName || 'N/A'}</div>
                            <div class="employee-id-cell">${employee.employeeId || 'N/A'}</div>
                        </td>
                        <td>${department.name || 'N/A'}</td>
                        <td>
                            <span class="badge ${payroll.payPeriod?.daysWorked === payroll.payPeriod?.workingDays ? 'bg-success' : 'bg-warning'}">
                                ${daysWorked}
                            </span>
                        </td>
                        <td class="fw-bold">${payroll.currency || 'MWK'} ${(payroll.grossPay || 0).toLocaleString()}</td>
                        <td class="text-danger fw-semibold">${payroll.currency || 'MWK'} ${(payroll.deductions?.total || 0).toLocaleString()}</td>
                        <td class="fw-bold text-success">${payroll.currency || 'MWK'} ${(payroll.netPay || 0).toLocaleString()}</td>
                        <td>
                            ${statusBadge}
                            <div class="mt-1">${approvalStatus}</div>
                        </td>
                        <td>
                            <div class="action-btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewPayrollDetails('${payroll._id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadPayslip('${payroll._id}')" title="Download Payslip">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { class: 'status-pending', icon: 'fa-clock', text: 'Pending' },
                'approved': { class: 'status-approved', icon: 'fa-check-circle', text: 'Approved' },
                'processing': { class: 'status-processing', icon: 'fa-spinner', text: 'Processing' },
                'paid': { class: 'status-paid', icon: 'fa-check-double', text: 'Paid' },
                'failed': { class: 'status-failed', icon: 'fa-times-circle', text: 'Failed' }
            };
            
            const statusInfo = statusMap[status] || { class: 'bg-secondary', icon: 'fa-question', text: 'Unknown' };
            return `<span class="payroll-status-badge ${statusInfo.class}">
                <i class="fas ${statusInfo.icon} me-1"></i>${statusInfo.text}
            </span>`;
        }

        // Get approval status
        function getApprovalStatus(payroll) {
            const hr = payroll.approvals?.hr?.status || 'pending';
            const finance = payroll.approvals?.finance?.status || 'pending';
            
            if (hr === 'rejected' || finance === 'rejected') {
                return '<small class="text-danger"><i class="fas fa-times-circle me-1"></i>Rejected</small>';
            } else if (hr === 'approved' && finance === 'approved') {
                return '<small class="text-success"><i class="fas fa-check-double me-1"></i>Fully Approved</small>';
            } else if (hr === 'approved' || finance === 'approved') {
                return '<small class="text-warning"><i class="fas fa-check-circle me-1"></i>Partially Approved</small>';
            } else {
                return '<small class="text-muted"><i class="fas fa-hourglass-half me-1"></i>Pending Approval</small>';
            }
        }

        // Filter payrolls
        function filterPayrolls() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredPayrolls = currentPayrolls.filter(payroll => {
                const matchesDepartment = !departmentFilter || 
                    payroll.employeeId?.employmentInfo?.departmentId?._id === departmentFilter;
                const matchesStatus = !statusFilter || 
                    payroll.payment?.status === statusFilter;
                
                return matchesDepartment && matchesStatus;
            });
            
            displayPayrolls();
        }

        // Update statistics
        function updateStatistics() {
            const totalEmployees = filteredPayrolls.length;
            const totalGross = filteredPayrolls.reduce((sum, p) => sum + (p.grossPay || 0), 0);
            const totalDeductions = filteredPayrolls.reduce((sum, p) => sum + (p.deductions?.total || 0), 0);
            const totalNet = filteredPayrolls.reduce((sum, p) => sum + (p.netPay || 0), 0);
            const currency = filteredPayrolls.length > 0 ? (filteredPayrolls[0].currency || 'MWK') : 'MWK';
            
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalGrossPay').textContent = `${currency} ${totalGross.toLocaleString()}`;
            document.getElementById('totalDeductions').textContent = `${currency} ${totalDeductions.toLocaleString()}`;
            document.getElementById('totalNetPay').textContent = `${currency} ${totalNet.toLocaleString()}`;
        }

        // View payroll details
        async function viewPayrollDetails(payrollId) {
            try {
                selectedPayrollId = payrollId;
                showLoading(true, 'payrollDetailsContent');
                
                const response = await axios.get(`/payroll/${payrollId}`);
                const payroll = response.data;
                
                displayPayrollDetails(payroll);
                
                const modal = new bootstrap.Modal(document.getElementById('payrollDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading payroll details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load payroll details'
                });
            } finally {
                showLoading(false, 'payrollDetailsContent');
            }
        }

        // Display payroll details (NEW PROFESSIONAL LAYOUT)
        function displayPayrollDetails(payroll) {
            const employee = payroll.employeeId || {};
            const personal = employee.personalInfo || {};
            const employment = employee.employmentInfo || {};
            const department = employment.departmentId || {};
            const position = employment.positionId || {};
            const grade = employment.gradeId || {};
            
            const fullName = `${personal.firstName || ''} ${personal.lastName || ''}`.trim();
            const currency = payroll.currency || 'MWK';
            const isPaid = payroll.payment?.status === 'paid';
            
            let content = '';
            
            // Show paid lock notice if payroll is marked as paid
            if (isPaid) {
                content += `
                    <div class="paid-lock-notice">
                        <div class="paid-lock-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="paid-lock-content">
                            <h5>Payroll Locked</h5>
                            <p>This payroll has been marked as paid and can no longer be modified. All adjustments are disabled.</p>
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="row">
                    <!-- Employee Information -->
                    <div class="col-lg-6 mb-3">
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <div class="detail-section-icon icon-employee">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    Employee Information
                                </div>
                                ${getStatusBadge(payroll.payment?.status || 'pending')}
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${fullName || 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Employee ID</div>
                                <div class="detail-value">${employee.employeeId || 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Department</div>
                                <div class="detail-value">${department.name || 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Position</div>
                                <div class="detail-value">${position.name || 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Grade</div>
                                <div class="detail-value">${grade.name || 'N/A'} (Level ${grade.level || 'N/A'})</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pay Period Information -->
                    <div class="col-lg-6 mb-3">
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <div class="detail-section-icon icon-period">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    Pay Period Details
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Payroll Month</div>
                                <div class="detail-value">${payroll.payrollMonth || 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Period Start</div>
                                <div class="detail-value">${payroll.payPeriod?.startDate ? new Date(payroll.payPeriod.startDate).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Period End</div>
                                <div class="detail-value">${payroll.payPeriod?.endDate ? new Date(payroll.payPeriod.endDate).toLocaleDateString() : 'N/A'}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Working Days</div>
                                <div class="detail-value">${payroll.payPeriod?.workingDays || 0} days</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Days Worked</div>
                                <div class="detail-value">
                                    ${payroll.payPeriod?.daysWorked || 0} days
                                    <span class="badge ${payroll.attendanceRate >= 90 ? 'bg-success' : payroll.attendanceRate >= 75 ? 'bg-warning' : 'bg-danger'} ms-2">
                                        ${payroll.attendanceRate || 0}% attendance
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Earnings Section -->
                    <div class="col-lg-6 mb-3">
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <div class="detail-section-icon icon-earnings">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    Earnings Breakdown
                                </div>
                            </div>
                            
                            ${generateEarningsBreakdown(payroll, isPaid)}
                        </div>
                    </div>

                    <!-- Deductions Section -->
                    <div class="col-lg-6 mb-3">
                        <div class="detail-section">
                            <div class="detail-section-header">
                                <div class="detail-section-title">
                                    <div class="detail-section-icon icon-deductions">
                                        <i class="fas fa-minus-circle"></i>
                                    </div>
                                    Deductions Breakdown
                                </div>
                            </div>
                            
                            ${generateDeductionsBreakdown(payroll, isPaid)}
                        </div>
                    </div>
                </div>

                <!-- Net Pay Card -->
                <div class="net-pay-card">
                    <div class="net-pay-label">Final Net Pay</div>
                    <div class="net-pay-amount">
                        ${currency} ${(payroll.netPay || 0).toLocaleString()}
                    </div>
                </div>

                ${generateApprovalsSection(payroll)}
                ${generateAdjustmentsSection(payroll)}
            `;
            
            document.getElementById('payrollDetailsContent').innerHTML = content;
        }

        // Generate earnings breakdown
        function generateEarningsBreakdown(payroll, isPaid) {
            const currency = payroll.currency || 'MWK';
            let html = '';
            
            // Basic Salary
            html += `
                <div class="amount-breakdown-item item-primary">
                    <div>
                        <div class="amount-name">Basic Salary</div>
                    </div>
                    <div class="amount-value">${currency} ${(payroll.salary?.base || 0).toLocaleString()}</div>
                </div>
            `;
            
            // Prorated Salary (if different from base)
            if (payroll.salary?.prorated && payroll.salary.prorated !== payroll.salary.base) {
                html += `
                    <div class="amount-breakdown-item">
                        <div>
                            <div class="amount-name">Prorated Salary</div>
                            <div class="amount-description">Based on ${payroll.payPeriod?.daysWorked || 0} days worked</div>
                        </div>
                        <div class="amount-value">${currency} ${(payroll.salary.prorated || 0).toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Allowances
            const allowances = payroll.allowances || {};
            const allowanceTypes = [
                { key: 'transport', label: 'Transport Allowance' },
                { key: 'housing', label: 'Housing Allowance' },
                { key: 'medical', label: 'Medical Allowance' },
                { key: 'meals', label: 'Meal Allowance' },
                { key: 'communication', label: 'Communication Allowance' },
                { key: 'other', label: 'Other Allowances' }
            ];
            
            allowanceTypes.forEach(type => {
                if (allowances[type.key] && allowances[type.key] > 0) {
                    html += `
                        <div class="amount-breakdown-item item-success">
                            <div>
                                <div class="amount-name">${type.label}</div>
                            </div>
                            <div class="amount-value">${currency} ${allowances[type.key].toLocaleString()}</div>
                        </div>
                    `;
                }
            });
            
            // Overtime
            if (payroll.overtime?.amount && payroll.overtime.amount > 0) {
                html += `
                    <div class="amount-breakdown-item item-success">
                        <div>
                            <div class="amount-name">Overtime</div>
                            <div class="amount-description">${payroll.overtime.hours}h @ ${currency} ${payroll.overtime.rate}/hr</div>
                        </div>
                        <div class="amount-value">${currency} ${payroll.overtime.amount.toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Bonuses
            const bonuses = payroll.bonuses || {};
            const bonusTypes = [
                { key: 'performance', label: 'Performance Bonus' },
                { key: 'annual', label: 'Annual Bonus' },
                { key: 'other', label: 'Other Bonuses' }
            ];
            
            bonusTypes.forEach(type => {
                if (bonuses[type.key] && bonuses[type.key] > 0) {
                    html += `
                        <div class="amount-breakdown-item item-success">
                            <div>
                                <div class="amount-name">${type.label}</div>
                            </div>
                            <div class="amount-value">${currency} ${bonuses[type.key].toLocaleString()}</div>
                        </div>
                    `;
                }
            });
            
            // Gross Pay Total
            html += `
                <div class="amount-breakdown-item item-total">
                    <div>
                        <div class="amount-name">GROSS PAY</div>
                    </div>
                    <div class="amount-value text-success">${currency} ${(payroll.grossPay || 0).toLocaleString()}</div>
                </div>
            `;
            
            return html;
        }

        // Generate deductions breakdown
        function generateDeductionsBreakdown(payroll, isPaid) {
            const currency = payroll.currency || 'MWK';
            let html = '';
            
            // Tax
            if (payroll.deductions?.tax?.amount && payroll.deductions.tax.amount > 0) {
                html += `
                    <div class="amount-breakdown-item item-danger">
                        <div>
                            <div class="amount-name">PAYE Tax</div>
                            <div class="amount-description">Rate: ${payroll.deductions.tax.rate}%</div>
                        </div>
                        <div class="amount-value">${currency} ${payroll.deductions.tax.amount.toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Pension
            if (payroll.deductions?.pension?.amount && payroll.deductions.pension.amount > 0) {
                html += `
                    <div class="amount-breakdown-item item-danger">
                        <div>
                            <div class="amount-name">Pension Contribution</div>
                            <div class="amount-description">Rate: ${payroll.deductions.pension.rate}%</div>
                        </div>
                        <div class="amount-value">${currency} ${payroll.deductions.pension.amount.toLocaleString()}</div>
                    </div>
                `;
            }
            
            // Loans
            if (payroll.deductions?.loans && payroll.deductions.loans.length > 0) {
                payroll.deductions.loans.forEach(loan => {
                    html += `
                        <div class="amount-breakdown-item item-danger">
                            <div>
                                <div class="amount-name">Loan Deduction</div>
                                <div class="amount-description">${loan.description || 'Loan repayment'}</div>
                            </div>
                            <div class="amount-value">${currency} ${loan.amount.toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            // Other deductions
            if (payroll.deductions?.other && payroll.deductions.other.length > 0) {
                payroll.deductions.other.forEach(item => {
                    html += `
                        <div class="amount-breakdown-item item-danger">
                            <div>
                                <div class="amount-name">${item.name || item.description || 'Other Deduction'}</div>
                                ${item.description ? `<div class="amount-description">${item.description}</div>` : ''}
                            </div>
                            <div class="amount-value">${currency} ${item.amount.toLocaleString()}</div>
                        </div>
                    `;
                });
            }
            
            // Total Deductions
            html += `
                <div class="amount-breakdown-item item-total-deductions">
                    <div>
                        <div class="amount-name">TOTAL DEDUCTIONS</div>
                    </div>
                    <div class="amount-value text-danger">${currency} ${(payroll.deductions?.total || 0).toLocaleString()}</div>
                </div>
            `;
            
            return html;
        }

        // Generate approvals section
        function generateApprovalsSection(payroll) {
            if (!payroll.approvals) return '';
            
            const hrStatus = payroll.approvals.hr?.status || 'pending';
            const financeStatus = payroll.approvals.finance?.status || 'pending';
            
            return `
                <div class="detail-section mt-3">
                    <div class="detail-section-header">
                        <div class="detail-section-title">
                            <div class="detail-section-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            Approval Status
                        </div>
                    </div>
                    
                    <div class="approval-status-grid">
                        <div class="approval-card ${hrStatus}">
                            <div class="approval-icon">
                                <i class="fas ${hrStatus === 'approved' ? 'fa-check' : hrStatus === 'rejected' ? 'fa-times' : 'fa-clock'}"></i>
                            </div>
                            <div class="approval-title">HR Approval</div>
                            <div class="approval-by">
                                ${payroll.approvals.hr?.approvedBy?.name || 'Pending'}
                            </div>
                            ${payroll.approvals.hr?.approvedAt ? `
                                <div class="approval-date">
                                    ${new Date(payroll.approvals.hr.approvedAt).toLocaleDateString()}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="approval-card ${financeStatus}">
                            <div class="approval-icon">
                                <i class="fas ${financeStatus === 'approved' ? 'fa-check' : financeStatus === 'rejected' ? 'fa-times' : 'fa-clock'}"></i>
                            </div>
                            <div class="approval-title">Finance Approval</div>
                            <div class="approval-by">
                                ${payroll.approvals.finance?.approvedBy?.name || 'Pending'}
                            </div>
                            ${payroll.approvals.finance?.approvedAt ? `
                                <div class="approval-date">
                                    ${new Date(payroll.approvals.finance.approvedAt).toLocaleDateString()}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate adjustments section
        function generateAdjustmentsSection(payroll) {
            if (!payroll.adjustments || payroll.adjustments.length === 0) return '';
            
            const currency = payroll.currency || 'MWK';
            
            return `
                <div class="detail-section mt-3">
                    <div class="detail-section-header">
                        <div class="detail-section-title">
                            <div class="detail-section-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                                <i class="fas fa-history"></i>
                            </div>
                            Adjustment History
                        </div>
                    </div>
                    
                    <div class="adjustments-timeline">
                        ${payroll.adjustments.map(adj => `
                            <div class="adjustment-item">
                                <div class="adjustment-card">
                                    <div class="adjustment-header">
                                        <div>
                                            <div class="adjustment-reason">${adj.reason}</div>
                                            <div class="adjustment-meta">
                                                <div class="adjustment-meta-item">
                                                    <i class="fas fa-tag"></i>
                                                    ${adj.category}
                                                </div>
                                                ${adj.duration === 'permanent' ? `
                                                    <div class="adjustment-meta-item">
                                                        <i class="fas fa-calendar"></i>
                                                        Permanent (${adj.durationDetails?.numberOfMonths || 0} months)
                                                    </div>
                                                ` : `
                                                    <div class="adjustment-meta-item">
                                                        <i class="fas fa-clock"></i>
                                                        Temporary
                                                    </div>
                                                `}
                                                <div class="adjustment-meta-item">
                                                    <i class="fas fa-calendar-day"></i>
                                                    ${adj.appliedAt ? new Date(adj.appliedAt).toLocaleDateString() : 'N/A'}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="adjustment-amount ${adj.type === 'addition' ? 'positive' : 'negative'}">
                                            ${adj.type === 'addition' ? '+' : '-'}${currency} ${Math.abs(adj.amount).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Download individual payslip
        async function downloadPayslip(payrollId = null) {
            const id = payrollId || selectedPayrollId;
            if (!id) return;

            try {
                const response = await axios.get(`/payroll/${id}/payslip`, {
                    params: { download: true },
                    responseType: 'blob'
                });

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `payslip_${id}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Payslip downloaded successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error downloading payslip:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to download payslip'
                });
            }
        }

        // Process payroll for all employees
        function processPayroll() {
            const selectedMonth = document.getElementById('selectedMonth').value;
            if (!selectedMonth) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            document.getElementById('processMonth').value = selectedMonth;
            const modal = new bootstrap.Modal(document.getElementById('processPayrollModal'));
            modal.show();
        }

        // Confirm payroll processing
        async function confirmProcessPayroll() {
            const month = document.getElementById('processMonth').value;
            if (!month) return;

            try {
                const result = await Swal.fire({
                    title: 'Confirm Payroll Processing',
                    text: `Process payroll for all active employees for ${month}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    confirmButtonText: 'Yes, Process!'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    const response = await axios.post('/payroll/process', { month });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: `Processed payroll for ${response.data.processedCount} employees`
                    });

                    bootstrap.Modal.getInstance(document.getElementById('processPayrollModal')).hide();
                    loadPayrollData();
                }
            } catch (error) {
                console.error('Error processing payroll:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to process payroll'
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate consolidated payslips
        async function generateConsolidatedPayslips() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                showLoading(true);

                const response = await axios.get(`/payroll/consolidated-payslips/${month}`, {
                    responseType: 'blob'
                });

                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `consolidated_payslips_${month}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Consolidated payslips generated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error generating consolidated payslips:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to generate consolidated payslips'
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate bank instruction
        async function generateBankInstruction() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                showLoading(true);
                
                const response = await axios.post('/payroll/export/bank-instruction/excel', 
                    { month }, 
                    { responseType: 'blob' }
                );

                const blob = new Blob([response.data], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `bank_instruction_${month}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Bank instruction Excel file generated successfully',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error generating bank instruction:', error);
                
                let errorMessage = 'Failed to generate bank instruction Excel file';
                if (error.response) {
                    if (error.response.status === 403) {
                        errorMessage = 'Access denied. Finance/Admin role required.';
                    } else if (error.response.status === 404) {
                        errorMessage = 'No payroll data found for the selected month';
                    } else if (error.response.status === 500) {
                        errorMessage = 'Server error occurred';
                    }
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage
                });
            } finally {
                showLoading(false);
            }
        }

        // Show reports modal
        function showReportsModal() {
            const month = document.getElementById('selectedMonth').value;
            if (month) {
                document.getElementById('reportMonth').value = month;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('reportsModal'));
            modal.show();
        }

        // Generate specific report from report card click
        async function generateSpecificReport(reportType) {
            const month = document.getElementById('reportMonth').value || document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                if (reportType === 'paye' || reportType === 'pension') {
                    const { value: format } = await Swal.fire({
                        title: 'Select Export Format',
                        text: 'Choose the format for your report',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Continue',
                        cancelButtonText: 'Cancel',
                        input: 'select',
                        inputOptions: {
                            'pdf': 'PDF Document',
                            'excel': 'Excel Spreadsheet'
                        },
                        inputPlaceholder: 'Select format',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Please select a format';
                            }
                        }
                    });

                    if (!format) return;
                    await generateReportWithFormat(reportType, month, format);
                } else {
                    await generateReportPDF(reportType, month);
                }
                
            } catch (error) {
                console.error('Error generating report:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Failed to generate ${reportType.toUpperCase()} report`
                });
            } finally {
                showLoading(false);
            }
        }

        // Generate report with specific format
        async function generateReportWithFormat(reportType, month, format = 'pdf') {
            try {
                showLoading(true);
                
                let endpoint, fileName, contentType;
                
                if (format === 'excel') {
                    switch(reportType) {
                        case 'paye':
                            endpoint = '/payroll/export/paye/excel';
                            break;
                        case 'pension':
                            endpoint = '/payroll/export/pension/excel';
                            break;
                        default:
                            endpoint = `/payroll/report/${reportType}`;
                            format = 'pdf';
                    }
                } else {
                    endpoint = `/payroll/report/${reportType}`;
                }
                
                if (format === 'excel') {
                    contentType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    fileName = `${reportType}_report_${month}.xlsx`;
                } else {
                    contentType = 'application/pdf';
                    fileName = `${reportType}_report_${month}.pdf`;
                }

                const response = await axios.post(endpoint, 
                    { month }, 
                    { responseType: 'blob' }
                );

                const blob = new Blob([response.data], { type: contentType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                const reportsModal = document.getElementById('reportsModal');
                if (reportsModal) {
                    const modal = bootstrap.Modal.getInstance(reportsModal);
                    if (modal) modal.hide();
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: `${reportType.toUpperCase()} report generated successfully as ${format.toUpperCase()}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error(`Error generating ${reportType} report (${format}):`, error);
                
                let errorMessage = `Failed to generate ${reportType.toUpperCase()} ${format.toUpperCase()} report`;
                if (error.response) {
                    if (error.response.status === 403) {
                        errorMessage = 'Access denied. Admin/HR/Finance role required.';
                    } else if (error.response.status === 404) {
                        errorMessage = 'No data found for the selected month';
                    } else if (error.response.status === 500) {
                        errorMessage = 'Server error occurred';
                    }
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: errorMessage
                });
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // Generate PDF report
        async function generateReportPDF(reportType, month) {
            await generateReportWithFormat(reportType, month, 'pdf');
        }

        // Generate selected report from dropdown
        async function generateSelectedReport() {
            const reportType = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').value;
            
            if (!reportType) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a report type'
                });
                return;
            }
            
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month'
                });
                return;
            }

            await generateSpecificReport(reportType);
        }

        // Create payroll from previous month
        async function createFromPrevious() {
            const month = document.getElementById('selectedMonth').value;
            if (!month) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Warning',
                    text: 'Please select a month first'
                });
                return;
            }

            try {
                const result = await Swal.fire({
                    title: 'Create from Previous Month',
                    text: `Create payroll records for ${month} using previous month's data?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#ef4444',
                    confirmButtonText: 'Yes, Create!'
                });

                if (result.isConfirmed) {
                    showLoading(true);
                    
                    const response = await axios.post('/payroll/create-from-previous', { month });
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: `Created payroll for ${response.data.processedCount} employees from previous month`
                    });

                    loadPayrollData();
                }
            } catch (error) {
                console.error('Error creating from previous month:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.response?.data?.error || 'Failed to create payroll from previous month'
                });
            } finally {
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show, targetId = null) {
            if (targetId) {
                const target = document.getElementById(targetId);
                if (show) {
                    target.innerHTML = `
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="text-muted">Loading payroll details...</div>
                        </div>
                    `;
                }
            } else {
                if (show) {
                    Swal.fire({
                        title: 'Processing...',
                        html: '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false
                    });
                } else {
                    Swal.close();
                }
            }
        }
    </script>
    <script src="/js/admin.js"></script>
</body>
</html>
