<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Reports & Analytics</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    
    <style>
        /* Enhanced Professional Styling */
        .summary-stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .summary-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(248, 195, 183, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(40%, -40%);
        }

        .summary-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(108, 12, 13, 0.15);
            border-color: var(--golden-yellow);
        }

        .stat-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon-wrapper.icon-employees {
            background: linear-gradient(135deg, rgba(108, 12, 13, 0.1) 0%, rgba(108, 12, 13, 0.05) 100%);
            color: var(--sidebar-dark-blue);
        }

        .stat-icon-wrapper.icon-departments {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            color: #3b82f6;
        }

        .stat-icon-wrapper.icon-positions {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            color: #10b981;
        }

        .stat-icon-wrapper.icon-payroll {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            color: #f59e0b;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .stat-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Enhanced Nav Tabs */
        .nav-tabs {
            border-bottom: 2px solid var(--border-color);
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--sidebar-dark-blue);
            background: rgba(248, 195, 183, 0.1);
            border-bottom-color: var(--golden-yellow);
        }

        .nav-tabs .nav-link.active {
            color: var(--sidebar-dark-blue);
            background: rgba(248, 195, 183, 0.15);
            border-bottom-color: var(--sidebar-dark-blue);
        }

        /* Filter Bar */
        .filter-bar {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .filter-bar .form-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* Enhanced Table Styling */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            color: var(--text-primary);
        }

        .table tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(248, 195, 183, 0.2);
        }

        /* Status Badges */
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-badge.badge-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-badge.badge-inactive {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .status-badge.badge-paid {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-badge.badge-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .status-badge.badge-approved {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .status-badge.badge-rejected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .status-badge.badge-verified {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-badge.badge-unverified {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        /* Chart Cards */
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(108, 12, 13, 0.1);
            color: var(--sidebar-dark-blue);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1.5rem;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--border-color);
        }

        .pagination {
            margin: 0;
        }

        .pagination .page-link {
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin: 0 2px;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-weight: 500;
        }

        .pagination .page-item.active .page-link {
            background: var(--sidebar-dark-blue);
            border-color: var(--sidebar-dark-blue);
            color: white;
        }

        .pagination .page-link:hover {
            background: var(--golden-yellow);
            border-color: var(--golden-yellow);
            color: var(--sidebar-dark-blue);
        }

        /* Export Button */
        .export-btn {
            background: linear-gradient(135deg, var(--sidebar-dark-blue) 0%, #8b0e0f 100%);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(108, 12, 13, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 12, 13, 0.3);
            background: linear-gradient(135deg, #8b0e0f 0%, var(--sidebar-dark-blue) 100%);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid rgba(108, 12, 13, 0.1);
            border-top-color: var(--sidebar-dark-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.5rem;
            }

            .filter-bar {
                padding: 1rem;
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .chart-container {
                height: 250px;
            }
        }

        /* Alert Styles */
        .alert-expiring-soon {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .alert-expiring-warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-expiring-ok {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid #10b981;
            color: #065f46;
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'reports' }) %>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <%- include('./partials/header', { 
             title: 'Reports & Analytics', 
             user: typeof user !== 'undefined' ? user : { name: 'User', email: '', avatar: 'U' } 
        }) %>
        
        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4 py-4">
                <!-- Summary Stats -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="summary-stat-card">
                            <div class="stat-icon-wrapper icon-employees">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-title">Total Employees</div>
                            <div class="stat-value" id="totalEmployees">0</div>
                            <div class="stat-subtitle" id="activeEmployees">0 Active</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="summary-stat-card">
                            <div class="stat-icon-wrapper icon-departments">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-title">Departments</div>
                            <div class="stat-value" id="totalDepartments">0</div>
                            <div class="stat-subtitle">All Active</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="summary-stat-card">
                            <div class="stat-icon-wrapper icon-positions">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <div class="stat-title">Positions</div>
                            <div class="stat-value" id="totalPositions">0</div>
                            <div class="stat-subtitle" id="vacantPositions">0 Vacant</div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="summary-stat-card">
                            <div class="stat-icon-wrapper icon-payroll">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-title">Payroll Status</div>
                            <div class="stat-value" id="payrollStatus" style="font-size: 1.3rem;">Not Processed</div>
                            <div class="stat-subtitle" id="currentMonthPayroll">Current Month</div>
                        </div>
                    </div>
                </div>

                <!-- Reports Navigation -->
                <div class="card">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="reportsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="employee-tab" data-bs-toggle="tab" data-bs-target="#employee" type="button" role="tab">
                                    <i class="fas fa-users me-2"></i>Employee Directory
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">
                                    <i class="fas fa-money-check-alt me-2"></i>Payroll History
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
                                    <i class="fas fa-file-alt me-2"></i>Document Expiry
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                                    <i class="fas fa-chart-line me-2"></i>Analytics
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-0">
                        <div class="tab-content p-4" id="reportsTabsContent">
                            <!-- Employee Directory Report -->
                            <div class="tab-pane fade show active" id="employee" role="tabpanel">
                                <div class="filter-bar">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="empDeptFilter" class="form-label">
                                                <i class="fas fa-building me-1"></i>Department
                                            </label>
                                            <select class="form-select" id="empDeptFilter">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="empGradeFilter" class="form-label">
                                                <i class="fas fa-layer-group me-1"></i>Grade
                                            </label>
                                            <select class="form-select" id="empGradeFilter">
                                                <option value="">All Grades</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="empStatusFilter" class="form-label">
                                                <i class="fas fa-toggle-on me-1"></i>Status
                                            </label>
                                            <select class="form-select" id="empStatusFilter">
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                                <option value="all">All</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="empSearch" class="form-label">
                                                <i class="fas fa-search me-1"></i>Search
                                            </label>
                                            <input type="text" class="form-control" id="empSearch" placeholder="Name, ID, Email">
                                        </div>
                                        <div class="col-12 text-end">
                                            <button class="btn btn-outline-primary" id="empFilterBtn">
                                                <i class="fas fa-filter me-1"></i>Apply Filters
                                            </button>
                                            <button class="btn export-btn ms-2" id="exportEmployeeBtn">
                                                <i class="fas fa-download me-1"></i>Export CSV
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="employeeTable">
                                            <thead>
                                                <tr>
                                                    <th>Employee ID</th>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Department</th>
                                                    <th>Position</th>
                                                    <th>Grade</th>
                                                    <th>Salary</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="8">
                                                        <div class="loading-state">
                                                            <div class="loading-spinner"></div>
                                                            <div>Loading employee data...</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="pagination-container" id="employeePagination"></div>
                                </div>
                            </div>

                            <!-- Payroll History Report -->
                            <div class="tab-pane fade" id="payroll" role="tabpanel">
                                <div class="filter-bar">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="payrollMonth" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Month
                                            </label>
                                            <input type="month" class="form-control" id="payrollMonth">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="payrollDeptFilter" class="form-label">
                                                <i class="fas fa-building me-1"></i>Department
                                            </label>
                                            <select class="form-select" id="payrollDeptFilter">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="payrollStatusFilter" class="form-label">
                                                <i class="fas fa-flag me-1"></i>Payment Status
                                            </label>
                                            <select class="form-select" id="payrollStatusFilter">
                                                <option value="">All Status</option>
                                                <option value="pending">Pending</option>
                                                <option value="approved">Approved</option>
                                                <option value="paid">Paid</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="payrollAmountRange" class="form-label">
                                                <i class="fas fa-money-bill me-1"></i>Amount Range (MWK)
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="payrollMinAmount" placeholder="Min">
                                                <span class="input-group-text">-</span>
                                                <input type="number" class="form-control" id="payrollMaxAmount" placeholder="Max">
                                            </div>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button class="btn btn-outline-primary" id="payrollFilterBtn">
                                                <i class="fas fa-filter me-1"></i>Apply Filters
                                            </button>
                                            <button class="btn export-btn ms-2" id="exportPayrollBtn">
                                                <i class="fas fa-download me-1"></i>Export CSV
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="payrollTable">
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Month</th>
                                                    <th>Gross Pay</th>
                                                    <th>Deductions</th>
                                                    <th>Net Pay</th>
                                                    <th>Payment Status</th>
                                                    <th>Approval Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="loading-state">
                                                            <div class="loading-spinner"></div>
                                                            <div>Loading payroll data...</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="pagination-container" id="payrollPagination"></div>
                                </div>
                            </div>

                            <!-- Document Expiry Report -->
                            <div class="tab-pane fade" id="documents" role="tabpanel">
                                <div class="filter-bar">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="docDaysFilter" class="form-label">
                                                <i class="fas fa-clock me-1"></i>Expiring Within (Days)
                                            </label>
                                            <input type="number" class="form-control" id="docDaysFilter" value="30" min="1">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="docTypeFilter" class="form-label">
                                                <i class="fas fa-file me-1"></i>Document Type
                                            </label>
                                            <select class="form-select" id="docTypeFilter">
                                                <option value="">All Types</option>
                                                <option value="id">ID</option>
                                                <option value="passport">Passport</option>
                                                <option value="resume">Resume</option>
                                                <option value="contract">Contract</option>
                                                <option value="certificate">Certificate</option>
                                                <option value="medical">Medical</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="docDeptFilter" class="form-label">
                                                <i class="fas fa-building me-1"></i>Department
                                            </label>
                                            <select class="form-select" id="docDeptFilter">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="docSortFilter" class="form-label">
                                                <i class="fas fa-sort me-1"></i>Sort By
                                            </label>
                                            <select class="form-select" id="docSortFilter">
                                                <option value="documents.expiryDate">Expiry Date</option>
                                                <option value="personalInfo.lastName">Employee Name</option>
                                            </select>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button class="btn btn-outline-primary" id="docFilterBtn">
                                                <i class="fas fa-filter me-1"></i>Apply Filters
                                            </button>
                                            <button class="btn export-btn ms-2" id="exportDocBtn">
                                                <i class="fas fa-download me-1"></i>Export CSV
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="documentsTable">
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Document</th>
                                                    <th>Type</th>
                                                    <th>Expiry Date</th>
                                                    <th>Days Remaining</th>
                                                    <th>Department</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="loading-state">
                                                            <div class="loading-spinner"></div>
                                                            <div>Loading document data...</div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="pagination-container" id="documentsPagination"></div>
                                </div>
                            </div>

                            <!-- Analytics Section -->
                            <div class="tab-pane fade" id="analytics" role="tabpanel">
                                <div class="filter-bar mb-4">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="analyticsTimeframe" class="form-label">
                                                <i class="fas fa-calendar-alt me-1"></i>Timeframe
                                            </label>
                                            <select class="form-select" id="analyticsTimeframe">
                                                <option value="3">Last 3 Months</option>
                                                <option value="6" selected>Last 6 Months</option>
                                                <option value="12">Last 12 Months</option>
                                                <option value="24">Last 24 Months</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="analyticsDeptFilter" class="form-label">
                                                <i class="fas fa-building me-1"></i>Department
                                            </label>
                                            <select class="form-select" id="analyticsDeptFilter">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="analyticsGradeFilter" class="form-label">
                                                <i class="fas fa-layer-group me-1"></i>Grade
                                            </label>
                                            <select class="form-select" id="analyticsGradeFilter">
                                                <option value="">All Grades</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button class="btn btn-outline-primary w-100" id="analyticsFilterBtn">
                                                <i class="fas fa-sync-alt me-1"></i>Update Analytics
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Department Analytics -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-card">
                                            <div class="chart-card-header">
                                                <h5 class="chart-card-title">
                                                    <div class="chart-icon">
                                                        <i class="fas fa-building"></i>
                                                    </div>
                                                    Department Analytics
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" id="exportDeptAnalyticsBtn">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="deptBudgetChart"></canvas>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="deptEmployeeChart"></canvas>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Salary Analytics -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-card">
                                            <div class="chart-card-header">
                                                <h5 class="chart-card-title">
                                                    <div class="chart-icon">
                                                        <i class="fas fa-money-bill-wave"></i>
                                                    </div>
                                                    Salary Analytics
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" id="exportSalaryAnalyticsBtn">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="salaryDistributionChart"></canvas>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="salaryByGradeChart"></canvas>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Workforce Analytics -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-card">
                                            <div class="chart-card-header">
                                                <h5 class="chart-card-title">
                                                    <div class="chart-icon">
                                                        <i class="fas fa-users"></i>
                                                    </div>
                                                    Workforce Analytics
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" id="exportWorkforceAnalyticsBtn">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="workforceDistributionChart"></canvas>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="hiringTrendsChart"></canvas>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Demographic Analytics -->
                                    <div class="col-lg-6 mb-4">
                                        <div class="chart-card">
                                            <div class="chart-card-header">
                                                <h5 class="chart-card-title">
                                                    <div class="chart-icon">
                                                        <i class="fas fa-chart-pie"></i>
                                                    </div>
                                                    Demographic Analytics
                                                </h5>
                                                <button class="btn btn-sm btn-outline-primary" id="exportDemographicAnalyticsBtn">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="ageDistributionChart"></canvas>
                                            </div>
                                            <div class="chart-container">
                                                <canvas id="genderDistributionChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
    
    <!-- Reports Script -->
    <script>
        // Global variables
        let currentEmployeePage = 1;
        let currentPayrollPage = 1;
        let currentDocumentsPage = 1;
        const itemsPerPage = 10;
        let departmentOptions = [];
        let gradeOptions = [];

        // Get token from localStorage
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
        }

        // Set up Axios defaults
        axios.defaults.baseURL = '/api';
        axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;

        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            loadSummaryStats();
            loadDepartmentOptions();
            loadGradeOptions();
            loadEmployeeReport();
            setupEventListeners();
        });

        // Sidebar functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
            });
        }

        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('show');
                this.classList.remove('show');
            });
        }

        // Load summary statistics
        async function loadSummaryStats() {
            try {
                const response = await axios.get('/reports/summary');
                
                if (response.data.success) {
                    const data = response.data.data;
                    document.getElementById('totalEmployees').textContent = data.employees.total;
                    document.getElementById('activeEmployees').textContent = `${data.employees.active} Active`;
                    document.getElementById('totalDepartments').textContent = data.departments.total;
                    document.getElementById('totalPositions').textContent = data.positions.total;
                    document.getElementById('vacantPositions').textContent = `${data.positions.vacant} Vacant`;
                    document.getElementById('payrollStatus').textContent = data.payroll.currentMonthProcessed ? 'Processed' : 'Not Processed';
                    document.getElementById('currentMonthPayroll').textContent = `Current Month: ${new Date().toLocaleString('default', { month: 'long' })}`;
                }
            } catch (error) {
                console.error('Error loading summary stats:', error);
                showError('Failed to load summary statistics');
            }
        }

        // Load department options for filters
        async function loadDepartmentOptions() {
            try {
                const response = await axios.get('/departments');
                
                if (response.data.success) {
                    departmentOptions = response.data.departments || response.data.data;
                    
                    const departmentSelects = [
                        'empDeptFilter', 'payrollDeptFilter', 'docDeptFilter', 'analyticsDeptFilter'
                    ];
                    
                    departmentSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">All Departments</option>';
                        
                        departmentOptions.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept._id;
                            option.textContent = dept.name;
                            select.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Load grade options for filters
        async function loadGradeOptions() {
            try {
                const response = await axios.get('/grades');
                
                if (response.data.success) {
                    gradeOptions = response.data.grades || response.data.data;
                    
                    const gradeSelects = [
                        'empGradeFilter', 'analyticsGradeFilter'
                    ];
                    
                    gradeSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">All Grades</option>';
                        
                        gradeOptions.forEach(grade => {
                            const option = document.createElement('option');
                            option.value = grade._id;
                            option.textContent = `${grade.name} (Level ${grade.level})`;
                            select.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading grades:', error);
            }
        }

        // Load employee directory report
        async function loadEmployeeReport(page = 1) {
            try {
                const department = document.getElementById('empDeptFilter').value;
                const grade = document.getElementById('empGradeFilter').value;
                const status = document.getElementById('empStatusFilter').value;
                const search = document.getElementById('empSearch').value;
                
                let url = `/reports/employees?page=${page}&limit=${itemsPerPage}`;
                if (department) url += `&department=${department}`;
                if (grade) url += `&grade=${grade}`;
                if (status !== 'all') url += `&status=${status}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await axios.get(url);
                
                if (response.data.success) {
                    const data = response.data.data;
                    currentEmployeePage = page;
                    
                    const tbody = document.getElementById('employeeTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.employees.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <div class="empty-state-text">No employees found</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        data.employees.forEach(emp => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${emp.employeeId}</strong></td>
                                <td><strong>${emp.personalInfo.firstName} ${emp.personalInfo.lastName}</strong></td>
                                <td>${emp.personalInfo.email}</td>
                                <td>${emp.employmentInfo.departmentId?.name || 'N/A'}</td>
                                <td>${emp.employmentInfo.positionId?.name || 'N/A'}</td>
                                <td><span class="badge bg-secondary">${emp.employmentInfo.gradeId?.name || 'N/A'}</span></td>
                                <td><strong>${formatCurrency(emp.employmentInfo.currentSalary)}</strong></td>
                                <td><span class="status-badge badge-${emp.employmentInfo.status === 'active' ? 'active' : 'inactive'}">${emp.employmentInfo.status}</span></td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    updatePagination('employeePagination', data.currentPage, data.totalPages, data.totalEmployees, loadEmployeeReport);
                }
            } catch (error) {
                console.error('Error loading employee report:', error);
                showError('Failed to load employee directory');
            }
        }

        // Load payroll history report
        async function loadPayrollReport(page = 1) {
            try {
                const month = document.getElementById('payrollMonth').value;
                const department = document.getElementById('payrollDeptFilter').value;
                const status = document.getElementById('payrollStatusFilter').value;
                const minAmount = document.getElementById('payrollMinAmount').value;
                const maxAmount = document.getElementById('payrollMaxAmount').value;
                
                let url = `/reports/payroll?page=${page}&limit=${itemsPerPage}`;
                if (month) url += `&month=${month}`;
                if (department) url += `&department=${department}`;
                if (status) url += `&paymentStatus=${status}`;
                if (minAmount) url += `&minAmount=${minAmount}`;
                if (maxAmount) url += `&maxAmount=${maxAmount}`;
                
                const response = await axios.get(url);
                
                if (response.data.success) {
                    const data = response.data.data;
                    currentPayrollPage = page;
                    
                    const tbody = document.getElementById('payrollTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.payrolls.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-receipt"></i>
                                        <div class="empty-state-text">No payroll records found</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        data.payrolls.forEach(payroll => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${payroll.employeeId.personalInfo.firstName} ${payroll.employeeId.personalInfo.lastName}</strong></td>
                                <td>${payroll.payrollMonth}</td>
                                <td><strong>${formatCurrency(payroll.grossPay)}</strong></td>
                                <td class="text-danger"><strong>${formatCurrency(payroll.deductions.total)}</strong></td>
                                <td class="text-success"><strong>${formatCurrency(payroll.netPay)}</strong></td>
                                <td><span class="status-badge badge-${payroll.payment.status}">${payroll.payment.status}</span></td>
                                <td><span class="status-badge badge-${payroll.approvalStatus}">${payroll.approvalStatus}</span></td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    updatePagination('payrollPagination', data.currentPage, data.totalPages, data.totalRecords, loadPayrollReport);
                }
            } catch (error) {
                console.error('Error loading payroll report:', error);
                showError('Failed to load payroll history');
            }
        }

        // Load document expiry report
        async function loadDocumentsReport(page = 1) {
            try {
                const days = document.getElementById('docDaysFilter').value;
                const type = document.getElementById('docTypeFilter').value;
                const department = document.getElementById('docDeptFilter').value;
                const sortBy = document.getElementById('docSortFilter').value;
                
                let url = `/reports/documents/expiry?page=${page}&limit=${itemsPerPage}&days=${days}`;
                if (type) url += `&documentType=${type}`;
                if (department) url += `&department=${department}`;
                url += `&sortBy=${sortBy}&sortOrder=asc`;
                
                const response = await axios.get(url);
                
                if (response.data.success) {
                    const data = response.data.data;
                    currentDocumentsPage = page;
                    
                    const tbody = document.getElementById('documentsTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.documents.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-file-alt"></i>
                                        <div class="empty-state-text">No expiring documents found</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        data.documents.forEach(doc => {
                            const daysRemaining = Math.floor(doc.daysToExpiry);
                            let badgeClass = 'alert-expiring-ok';
                            let textClass = 'text-success';
                            if (daysRemaining < 7) {
                                badgeClass = 'alert-expiring-soon';
                                textClass = 'text-danger';
                            } else if (daysRemaining < 30) {
                                badgeClass = 'alert-expiring-warning';
                                textClass = 'text-warning';
                            }
                            
                            const row = document.createElement('tr');
                            row.className = badgeClass;
                            row.innerHTML = `
                                <td><strong>${doc.personalInfo.firstName} ${doc.personalInfo.lastName}</strong></td>
                                <td>${doc.document.name}</td>
                                <td><span class="badge bg-secondary">${doc.document.type}</span></td>
                                <td>${new Date(doc.document.expiryDate).toLocaleDateString()}</td>
                                <td><strong class="${textClass}">${daysRemaining} days</strong></td>
                                <td>${doc.department?.name || 'N/A'}</td>
                                <td><span class="status-badge badge-${doc.document.isVerified ? 'verified' : 'unverified'}">${doc.document.isVerified ? 'Verified' : 'Pending'}</span></td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                    
                    updatePagination('documentsPagination', data.currentPage, data.totalPages, data.totalDocuments, loadDocumentsReport);
                }
            } catch (error) {
                console.error('Error loading documents report:', error);
                showError('Failed to load document expiry report');
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const timeframe = document.getElementById('analyticsTimeframe').value;
                const department = document.getElementById('analyticsDeptFilter').value;
                const grade = document.getElementById('analyticsGradeFilter').value;
                
                // Load department analytics
                let deptUrl = `/reports/analytics/departments?timeframe=${timeframe}`;
                const deptResponse = await axios.get(deptUrl);
                
                if (deptResponse.data.success) {
                    renderDepartmentAnalytics(deptResponse.data.data);
                }
                
                // Load salary analytics
                let salaryUrl = `/reports/analytics/salary`;
                if (department) salaryUrl += `?department=${department}`;
                if (grade) salaryUrl += `${department ? '&' : '?'}grade=${grade}`;
                
                const salaryResponse = await axios.get(salaryUrl);
                
                if (salaryResponse.data.success) {
                    renderSalaryAnalytics(salaryResponse.data.data);
                }
                
                // Load workforce analytics
                let workforceUrl = `/reports/analytics/workforce?period=${timeframe}`;
                const workforceResponse = await axios.get(workforceUrl);
                
                if (workforceResponse.data.success) {
                    renderWorkforceAnalytics(workforceResponse.data.data);
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showError('Failed to load analytics data');
            }
        }

        // Render department analytics charts
        function renderDepartmentAnalytics(data) {
            const deptBudgetCtx = document.getElementById('deptBudgetChart').getContext('2d');
            new Chart(deptBudgetCtx, {
                type: 'bar',
                data: {
                    labels: data.departmentStats.map(dept => dept.name),
                    datasets: [{
                        label: 'Budget Utilization (%)',
                        data: data.departmentStats.map(dept => dept.budgetUtilization),
                        backgroundColor: 'rgba(108, 12, 13, 0.7)',
                        borderColor: 'rgba(108, 12, 13, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Utilization (%)'
                            }
                        }
                    }
                }
            });
            
            const deptEmployeeCtx = document.getElementById('deptEmployeeChart').getContext('2d');
            new Chart(deptEmployeeCtx, {
                type: 'doughnut',
                data: {
                    labels: data.departmentStats.map(dept => dept.name),
                    datasets: [{
                        label: 'Employee Count',
                        data: data.departmentStats.map(dept => dept.employeeCount),
                        backgroundColor: [
                            'rgba(108, 12, 13, 0.7)',
                            'rgba(241, 151, 137, 0.7)',
                            'rgba(248, 195, 183, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Render salary analytics charts
        function renderSalaryAnalytics(data) {
            const salaryDistCtx = document.getElementById('salaryDistributionChart').getContext('2d');
            new Chart(salaryDistCtx, {
                type: 'bar',
                data: {
                    labels: data.salaryRanges.map(range => {
                        if (range._id === 'Other') return 'Other';
                        return `${formatCurrency(range._id)}`;
                    }),
                    datasets: [{
                        label: 'Employee Count',
                        data: data.salaryRanges.map(range => range.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Employee Count'
                            }
                        }
                    }
                }
            });
            
            const salaryGradeCtx = document.getElementById('salaryByGradeChart').getContext('2d');
            new Chart(salaryGradeCtx, {
                type: 'line',
                data: {
                    labels: data.salaryByGrade.map(item => item._id.gradeName),
                    datasets: [{
                        label: 'Average Salary (MWK)',
                        data: data.salaryByGrade.map(item => item.avgSalary),
                        fill: false,
                        borderColor: 'rgba(108, 12, 13, 1)',
                        backgroundColor: 'rgba(108, 12, 13, 0.1)',
                        tension: 0.1,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Salary (MWK)'
                            }
                        }
                    }
                }
            });
        }

        // Render workforce analytics charts
        function renderWorkforceAnalytics(data) {
            const workforceDistCtx = document.getElementById('workforceDistributionChart').getContext('2d');
            new Chart(workforceDistCtx, {
                type: 'pie',
                data: {
                    labels: data.statusDistribution.map(item => item._id),
                    datasets: [{
                        label: 'Employee Count',
                        data: data.statusDistribution.map(item => item.count),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            const hiringTrendsCtx = document.getElementById('hiringTrendsChart').getContext('2d');
            const hiringLabels = data.hiringTrends.map(item => `${item._id.year}-${item._id.month}`);
            
            new Chart(hiringTrendsCtx, {
                type: 'line',
                data: {
                    labels: hiringLabels,
                    datasets: [{
                        label: 'Hires',
                        data: data.hiringTrends.map(item => item.hires),
                        fill: false,
                        borderColor: 'rgba(241, 151, 137, 1)',
                        backgroundColor: 'rgba(241, 151, 137, 0.1)',
                        tension: 0.1,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Hires'
                            }
                        }
                    }
                }
            });
            
            const ageDistCtx = document.getElementById('ageDistributionChart').getContext('2d');
            new Chart(ageDistCtx, {
                type: 'bar',
                data: {
                    labels: data.ageDistribution.map(item => {
                        if (item._id === 'Other') return 'Other';
                        return `${item._id} - ${data.ageDistribution[data.ageDistribution.indexOf(item) + 1]?._id || ''}`;
                    }),
                    datasets: [{
                        label: 'Employee Count',
                        data: data.ageDistribution.map(item => item.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Employee Count'
                            }
                        }
                    }
                }
            });
            
            const genderDistCtx = document.getElementById('genderDistributionChart').getContext('2d');
            new Chart(genderDistCtx, {
                type: 'doughnut',
                data: {
                    labels: data.genderDistribution.map(item => item._id),
                    datasets: [{
                        label: 'Employee Count',
                        data: data.genderDistribution.map(item => item.count),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('empFilterBtn').addEventListener('click', () => loadEmployeeReport(1));
            document.getElementById('payrollFilterBtn').addEventListener('click', () => loadPayrollReport(1));
            document.getElementById('docFilterBtn').addEventListener('click', () => loadDocumentsReport(1));
            document.getElementById('analyticsFilterBtn').addEventListener('click', loadAnalytics);
            
            document.getElementById('exportEmployeeBtn').addEventListener('click', exportEmployeeCSV);
            document.getElementById('exportPayrollBtn').addEventListener('click', exportPayrollCSV);
            document.getElementById('exportDocBtn').addEventListener('click', exportDocumentsCSV);
            
            document.getElementById('employee-tab').addEventListener('click', () => {
                if (document.getElementById('employeeTable').querySelector('tbody').children.length === 1) {
                    loadEmployeeReport();
                }
            });
            
            document.getElementById('payroll-tab').addEventListener('click', () => {
                if (document.getElementById('payrollTable').querySelector('tbody').children.length === 1) {
                    loadPayrollReport();
                }
            });
            
            document.getElementById('documents-tab').addEventListener('click', () => {
                if (document.getElementById('documentsTable').querySelector('tbody').children.length === 1) {
                    loadDocumentsReport();
                }
            });
            
            document.getElementById('analytics-tab').addEventListener('click', loadAnalytics);
        }

        // Export employee data to CSV
        async function exportEmployeeCSV() {
            try {
                const department = document.getElementById('empDeptFilter').value;
                const grade = document.getElementById('empGradeFilter').value;
                const status = document.getElementById('empStatusFilter').value;
                const search = document.getElementById('empSearch').value;
                
                let url = `/reports/export/csv?reportType=employees`;
                if (department) url += `&department=${department}`;
                if (grade) url += `&grade=${grade}`;
                if (status !== 'all') url += `&status=${status}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await axios.get(url, {
                    responseType: 'blob'
                });
                
                const blob = new Blob([response.data], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = `employee_directory_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                
                showSuccess('Employee data exported successfully');
            } catch (error) {
                console.error('Error exporting employee data:', error);
                showError('Failed to export employee data');
            }
        }

        // Export payroll data to CSV
        async function exportPayrollCSV() {
            showInfo('Payroll export feature will be implemented soon');
        }

        // Export documents data to CSV
        async function exportDocumentsCSV() {
            showInfo('Documents export feature will be implemented soon');
        }

        // Helper function to update pagination
        function updatePagination(elementId, currentPage, totalPages, totalItems, callback) {
            const paginationContainer = document.getElementById(elementId);
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            const paginationWrapper = document.createElement('div');
            paginationWrapper.className = 'd-flex justify-content-between align-items-center w-100';
            
            // Info text
            const info = document.createElement('div');
            info.className = 'text-muted';
            info.textContent = `Showing ${((currentPage - 1) * itemsPerPage) + 1} to ${Math.min(currentPage * itemsPerPage, totalItems)} of ${totalItems} entries`;
            paginationWrapper.appendChild(info);
            
            // Pagination
            const pagination = document.createElement('ul');
            pagination.className = 'pagination mb-0';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) callback(currentPage - 1);
            });
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    callback(i);
                });
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) callback(currentPage + 1);
            });
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
            
            paginationWrapper.appendChild(pagination);
            paginationContainer.appendChild(paginationWrapper);
        }

        // Helper function to format currency in MWK
        function formatCurrency(amount) {
            return `MWK ${Number(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        // Helper functions for notifications
        function showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: message,
                confirmButtonColor: '#6c0c0d'
            });
        }

        function showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: message,
                timer: 2000,
                showConfirmButton: false
            });
        }

        function showInfo(message) {
            Swal.fire({
                icon: 'info',
                title: 'Information',
                text: message,
                confirmButtonColor: '#6c0c0d'
            });
        }
    </script>
</body>
</html>
