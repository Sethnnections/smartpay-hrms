<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Settings</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.12/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Animate CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">  
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="/css/dashboard.css">
   <style>
    :root {
      --sidebar-dark-blue: #6c0c0d;
      --sidebar-dark-blue-hover: #f19789;
      --golden-yellow: #f1d5d1;
      --golden-yellow-light: #f7f2f2;
      --bg-white: #ffffff;
      --text-primary: #181f2b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --warning-orange: #fd7e14;
      --sidebar-width: 280px; 
      --header-height: 70px;
      --border-radius: 8px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--golden-yellow-light);
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    /* Header */
    .navbar {
      background: var(--sidebar-dark-blue) !important;
      height: var(--header-height);
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 0 1.5rem;
    }
    
    .navbar-brand {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--bg-white) !important;
    }
    
    /* Cards */
    .card {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--box-shadow);
      margin-bottom: 1.25rem;
    }
    
    .card-header {
      background: var(--bg-white);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.25rem;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
    }
    
    .card-body {
      padding: 1.25rem;
    }
    
    /* Month Navigation */
    .month-navigation {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      padding: 1rem 1.25rem;
      box-shadow: var(--box-shadow);
      border: 1px solid var(--border-color);
      margin-bottom: 1.25rem;
    }
    
    .month-navigation h5 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--sidebar-dark-blue);
      margin: 0;
    }
    
    .month-navigation small {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    /* Workflow Steps */
    .workflow-steps-container {
      position: relative;
      padding: 1.5rem 0;
    }
    
    .workflow-step {
      position: relative;
      padding: 1rem 1.25rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }
    
    .workflow-step:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateX(3px);
    }
    
    .workflow-step.completed {
      background: linear-gradient(to right, rgba(40, 167, 69, 0.05) 0%, var(--bg-white) 100%);
      border-left: 3px solid var(--success-green);
    }
    
    .workflow-step.in-progress {
      background: linear-gradient(to right, rgba(253, 126, 20, 0.05) 0%, var(--bg-white) 100%);
      border-left: 3px solid var(--warning-orange);
      box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.1);
    }
    
    .workflow-step.rejected {
      background: linear-gradient(to right, rgba(220, 53, 69, 0.05) 0%, var(--bg-white) 100%);
      border-left: 3px solid var(--danger-red);
    }
    
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--border-color);
      color: var(--text-secondary);
      border-radius: 50%;
      margin-right: 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    
    .step-number.completed {
      background: var(--success-green);
      color: var(--bg-white);
    }
    
    .step-number.in-progress {
      background: var(--warning-orange);
      color: var(--bg-white);
      animation: pulse-ring 2s infinite;
    }
    
    .step-number.rejected {
      background: var(--danger-red);
      color: var(--bg-white);
    }
    
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(253, 126, 20, 0); }
      100% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0); }
    }
    
    .step-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .step-description {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .step-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .status-pending {
      background: var(--golden-yellow);
      color: var(--text-primary);
    }
    
    .status-approved {
      background: var(--success-green);
      color: var(--bg-white);
    }
    
    .status-rejected {
      background: var(--danger-red);
      color: var(--bg-white);
    }
    
    .step-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }
    
    /* Workflow Connector */
    .workflow-connector {
      position: absolute;
      left: 30px;
      top: 48px;
      width: 2px;
      height: 30px;
      background: var(--border-color);
      z-index: 0;
    }
    
    .workflow-connector.completed {
      background: var(--success-green);
    }
    
    /* Alerts */
    .alert-custom {
      border-radius: var(--border-radius);
      border: 1px solid;
      padding: 0.875rem 1rem;
      font-size: 0.875rem;
    }
    
    .alert-info {
      background: rgba(59, 130, 246, 0.08);
      border-color: rgba(59, 130, 246, 0.2);
      color: #1e40af;
    }
    
    .alert-success {
      background: rgba(40, 167, 69, 0.08);
      border-color: rgba(40, 167, 69, 0.2);
      color: #166534;
    }
    
    .alert-warning {
      background: rgba(253, 126, 20, 0.08);
      border-color: rgba(253, 126, 20, 0.2);
      color: #9a3412;
    }
    
    .alert-danger {
      background: rgba(220, 53, 69, 0.08);
      border-color: rgba(220, 53, 69, 0.2);
      color: #991b1b;
    }
    
    /* Buttons */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 500;
      font-size: 0.875rem;
      transition: var(--transition);
      border: none;
    }
    
    .btn-primary {
      background: var(--sidebar-dark-blue);
      color: var(--bg-white);
    }
    
    .btn-primary:hover {
      background: var(--sidebar-dark-blue-hover);
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(108, 12, 13, 0.2);
    }
    
    .btn-success {
      background: var(--success-green);
      color: var(--bg-white);
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger-red);
      color: var(--bg-white);
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .btn-outline-primary {
      border: 1px solid var(--sidebar-dark-blue);
      color: var(--sidebar-dark-blue);
      background: transparent;
    }
    
    .btn-outline-primary:hover {
      background: var(--sidebar-dark-blue);
      color: var(--bg-white);
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.875rem;
      margin-bottom: 1.25rem;
    }
    
    .stats-card {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      padding: 1rem;
      text-align: center;
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }
    
    .stats-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    
    .stats-card.stats-total {
      border-top: 3px solid var(--sidebar-dark-blue);
    }
    
    .stats-card.stats-completed {
      border-top: 3px solid var(--success-green);
    }
    
    .stats-card.stats-pending {
      border-top: 3px solid var(--warning-orange);
    }
    
    .stats-card.stats-rejected {
      border-top: 3px solid var(--danger-red);
    }
    
    .stats-number {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .stats-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    /* History Items */
    .history-item {
      padding: 0.875rem;
      border-radius: var(--border-radius);
      margin-bottom: 0.625rem;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      transition: var(--transition);
      cursor: pointer;
    }
    
    .history-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-color: var(--sidebar-dark-blue);
      transform: translateX(3px);
    }
    
    .history-item.completed {
      border-left: 3px solid var(--success-green);
    }
    
    .history-item.rejected {
      border-left: 3px solid var(--danger-red);
    }
    
    .history-item.in-progress {
      border-left: 3px solid var(--warning-orange);
    }
    
    .history-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .history-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    /* Badges */
    .badge-status {
      padding: 0.35rem 0.75rem;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      font-size: 0.7rem;
    }
    
    .badge-pending { 
      background: var(--golden-yellow);
      color: var(--text-primary);
    }
    
    .badge-paid, .badge-approved, .badge-completed { 
      background: var(--success-green);
      color: var(--bg-white);
    }
    
    .badge-rejected { 
      background: var(--danger-red);
      color: var(--bg-white);
    }
    
    /* User Avatar */
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--sidebar-dark-blue);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--bg-white);
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    /* Tables */
    .table {
      font-size: 0.875rem;
    }
    
    .table thead th {
      background: var(--golden-yellow-light);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 0.75rem;
      border: none;
    }
    
    .table tbody td {
      padding: 0.875rem 0.75rem;
      vertical-align: middle;
      border-bottom: 1px solid var(--border-color);
    }
    
    .table tbody tr:hover {
      background: var(--golden-yellow-light);
    }
    
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 3rem 1.5rem;
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--text-secondary);
      opacity: 0.3;
      margin-bottom: 1rem;
    }
    
    .empty-state h5 {
      color: var(--text-secondary);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .empty-state p {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
    
    /* Generate Payroll Section */
    .generate-payroll-card {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .form-label {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .form-control {
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      padding: 0.625rem 0.875rem;
      font-size: 0.875rem;
    }
    
    .form-control:focus {
      border-color: var(--sidebar-dark-blue);
      box-shadow: 0 0 0 3px rgba(108, 12, 13, 0.1);
    }
    
    /* Progress Bar */
    .progress-wrapper {
      background: var(--golden-yellow-light);
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
    }
    
    .progress-bar-inner {
      height: 100%;
      background: var(--success-green);
      border-radius: 8px;
      transition: width 0.5s ease;
    }
    
    /* Dropdown */
    .dropdown-menu {
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 0.5rem;
    }
    
    .dropdown-item {
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      color: var(--text-primary);
    }
    
    .dropdown-item:hover {
      background: var(--golden-yellow-light);
      color: var(--sidebar-dark-blue);
    }
    
    /* Loading Spinner */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
      border-width: 2px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .month-navigation {
        padding: 1rem;
      }
      
      .workflow-step {
        padding: 0.875rem;
      }
    }
    
    /* Utility Classes */
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .fw-semibold { font-weight: 600; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--golden-yellow-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'Process Payroll' }) %>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <%- include('./partials/header', { 
            title: 'Payroll workflows', 
            user: typeof user !== 'undefined' ? user : { name: 'User', email: '', avatar: 'U' } 
        }) %>

        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4">
               

    <!-- Month Navigation -->
    <div class="month-navigation">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-1">
            <i class="fas fa-calendar-alt me-2"></i>
            <span id="currentMonthDisplay">Loading...</span>
          </h5>
          <small id="workflowInfo">Workflow status will appear here</small>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <button class="btn btn-outline-primary btn-sm" id="prevMonthBtn">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="dropdown">
              <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="monthDropdown" data-bs-toggle="dropdown">
                Select Month
              </button>
              <ul class="dropdown-menu" id="monthList">
                <!-- Months will be loaded here -->
              </ul>
            </div>
            <button class="btn btn-outline-primary btn-sm" id="nextMonthBtn">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="row">
      <!-- Workflow Section -->
      <div class="col-lg-8">
        <!-- Workflow Card -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <i class="fas fa-project-diagram me-2"></i>Payroll Workflow
                <small class="text-secondary ms-2">HR → Employee → Admin</small>
              </div>
              <div class="user-avatar" id="initiatorAvatar" title="Workflow Initiator">
                <span>?</span>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Workflow Status Message -->
            <div id="workflowMessage" class="alert-custom alert-info mb-3">
              <div class="d-flex align-items-start">
                <i class="fas fa-info-circle me-2 mt-1"></i>
                <div>
                  <div class="fw-semibold mb-1" id="messageTitle">Loading workflow status...</div>
                  <div class="text-sm" id="messageText">Please wait while we load the workflow information.</div>
                </div>
              </div>
            </div>
            
            <!-- No Workflow State -->
            <div id="noWorkflowState" class="empty-state" style="display: none;">
              <i class="fas fa-clipboard-check"></i>
              <h5>No Payroll Workflow Started</h5>
              <p>Initiate a workflow to start the three-step approval process</p>
              <button class="btn btn-primary" id="startWorkflowBtn">
                <i class="fas fa-play-circle me-2"></i> Start New Workflow
              </button>
            </div>
            
            <!-- Workflow Steps -->
            <div id="workflowSteps" class="workflow-steps-container" style="display: none;">
              <!-- Steps will be loaded here -->
            </div>
            
            <!-- Workflow Actions -->
            <div id="workflowActions" class="mt-3" style="display: none;">
              <div class="alert-custom alert-warning mb-3">
                <div class="d-flex align-items-start">
                  <i class="fas fa-user-check me-2 mt-1"></i>
                  <div>
                    <div class="fw-semibold mb-1">Action Required!</div>
                    <div class="text-sm" id="actionMessage">You have a pending approval</div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-success" id="approveBtn">
                  <i class="fas fa-check-circle me-2"></i> Approve
                </button>
                <button class="btn btn-danger" id="rejectBtn">
                  <i class="fas fa-times-circle me-2"></i> Reject
                </button>
              </div>
            </div>
            
            <!-- Generate Payroll Section -->
            <div id="generatePayrollSection" class="mt-3" style="display: none;">
              <div class="alert-custom alert-success mb-3">
                <div class="d-flex align-items-start">
                  <i class="fas fa-check-circle me-2 mt-1"></i>
                  <div>
                    <div class="fw-semibold mb-1">All Approvals Complete!</div>
                    <div class="text-sm">You can now generate payroll for this month</div>
                  </div>
                </div>
              </div>
              
              <div class="generate-payroll-card">
                <div class="card">
                  <div class="card-body">
                    <h6 class="mb-3">
                      <i class="fas fa-cogs me-2"></i>Generate Payroll
                    </h6>
                    <div class="mb-3">
                      <label class="form-label">Payroll Month</label>
                      <input type="month" id="payrollMonth" class="form-control" value="">
                    </div>
                    <div class="mb-3">
                      <div class="progress-wrapper mb-2">
                        <div class="progress-bar-inner" style="width: 0%"></div>
                      </div>
                      <small class="text-secondary" id="progressText">Ready to generate</small>
                    </div>
                    <button class="btn btn-success w-100" id="generatePayrollBtn">
                      <i class="fas fa-cogs me-2"></i> Generate Payroll
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Generated Payrolls -->
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <div><i class="fas fa-table me-2"></i>Generated Payrolls</div>
              <span class="badge bg-primary" id="payrollCount">0</span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0" id="payrollsTable">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Generated By</th>
                    <th>Date</th>
                    <th>Employees</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="7" class="text-center py-5">
                      <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                      Loading payroll records...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stats-card stats-total">
            <div class="stats-number" id="totalWorkflows">0</div>
            <div class="stats-label">Total</div>
          </div>
          <div class="stats-card stats-completed">
            <div class="stats-number" id="completedWorkflows">0</div>
            <div class="stats-label">Completed</div>
          </div>
          <div class="stats-card stats-pending">
            <div class="stats-number" id="pendingWorkflows">0</div>
            <div class="stats-label">Pending</div>
          </div>
          <div class="stats-card stats-rejected">
            <div class="stats-number" id="rejectedWorkflows">0</div>
            <div class="stats-label">Rejected</div>
          </div>
        </div>
        
        <!-- Workflow History -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-history me-2"></i>Recent History
          </div>
          <div class="card-body">
            <div id="workflowHistory">
              <!-- History items will be loaded here -->
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-outline-primary btn-sm w-100" id="viewAllHistory">
                <i class="fas fa-list me-2"></i> View All History
              </button>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-bolt me-2"></i>Quick Actions
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
                <i class="fas fa-sync-alt me-2"></i> Refresh Data
              </button>
              <button class="btn btn-outline-primary btn-sm" id="viewReportBtn">
                <i class="fas fa-chart-bar me-2"></i> View Reports
              </button>
              <button class="btn btn-outline-primary btn-sm" id="helpBtn">
                <i class="fas fa-question-circle me-2"></i> Get Help
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

        </main>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (for simpler DOM manipulation) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
      
  <!-- SCRIPTS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

  <script>
  // Global variables
  let currentUser = null;
  let currentMonth = moment().format('YYYY-MM');
  let workflowData = null;
  let payrollData = [];

  // Get user data from localStorage
  function getUserData() {
    const userData = localStorage.getItem("user");
    if (userData) {
      currentUser = JSON.parse(userData);
      updateHeaderUserSection();
    } else {
      window.location.href = '/login';
    }
  }

  // Update header with user info
  function updateHeaderUserSection() {
    const headerSection = document.getElementById("headerUserSection");
    if (currentUser) {
      headerSection.innerHTML = `
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown">
            <div class="user-avatar me-2">
              ${currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U'}
            </div>
            <div class="text-start">
              <div class="text-xs fw-semibold">${currentUser.name || 'User'}</div>
              <div class="text-xs opacity-75">${currentUser.role.toUpperCase()}</div>
            </div>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
          </ul>
        </div>
      `;
    }
  }

  // Auth header for API calls
  const authHeader = () => ({
    Authorization: `Bearer ${localStorage.getItem('authToken')}`
  });

  // Initialize application
  $(document).ready(function() {
    getUserData();
    initApplication();
  });

  function initApplication() {
    // Set current month display
    $('#currentMonthDisplay').text(moment(currentMonth).format('MMMM YYYY'));
    $('#payrollMonth').val(currentMonth);
    
    // Load initial data
    loadWorkflowStatus(currentMonth);
    loadGeneratedPayrolls();
    loadWorkflowHistory();
    loadMonthList();
    
    // Event listeners
    setupEventListeners();
  }

  function setupEventListeners() {
    // Month navigation
    $('#prevMonthBtn').click(() => navigateMonth(-1));
    $('#nextMonthBtn').click(() => navigateMonth(1));
    
    // Workflow actions
    $('#startWorkflowBtn').click(startWorkflow);
    $('#approveBtn').click(approveStep);
    $('#rejectBtn').click(rejectStep);
    $('#generatePayrollBtn').click(generatePayroll);
    
    // Quick actions
    $('#refreshBtn').click(refreshData);
    $('#viewReportBtn').click(viewReports);
    $('#helpBtn').click(showHelp);
    $('#viewAllHistory').click(viewAllHistory);
    
    // Month selection
    $(document).on('click', '.month-item', function() {
      const month = $(this).data('month');
      selectMonth(month);
    });
  }

  function navigateMonth(direction) {
    currentMonth = moment(currentMonth).add(direction, 'months').format('YYYY-MM');
    $('#currentMonthDisplay').text(moment(currentMonth).format('MMMM YYYY'));
    $('#payrollMonth').val(currentMonth);
    loadWorkflowStatus(currentMonth);
  }

  function selectMonth(month) {
    currentMonth = month;
    $('#currentMonthDisplay').text(moment(currentMonth).format('MMMM YYYY'));
    $('#payrollMonth').val(currentMonth);
    loadWorkflowStatus(currentMonth);
  }

  async function loadWorkflowStatus(month) {
    try {
      showLoading('#workflowSteps', 'Loading workflow status...');
      
      const response = await axios.get(`/api/workflow/status/${month}`, {
        headers: authHeader()
      });
      
      workflowData = response.data;
      updateWorkflowUI(response.data);
      checkMyPendingApprovals();
    } catch (error) {
      console.error('Error loading workflow status:', error);
      showError('Failed to load workflow status');
    }
  }

  function updateWorkflowUI(data) {
    // Update workflow info
    $('#workflowInfo').text(
      data.exists ? 
      `Workflow ${data.status.replace('_', ' ').toUpperCase()}` : 
      'No workflow for this month'
    );
    
    if (!data.exists) {
      // No workflow exists
      $('#noWorkflowState').show();
      $('#workflowSteps, #workflowActions, #generatePayrollSection').hide();
      $('#messageTitle').text('No Workflow Started');
      $('#messageText').text('Start a new workflow to begin the approval process for this month.');
      $('#initiatorAvatar span').text('?');
      return;
    }
    
    // Show workflow steps
    $('#noWorkflowState').hide();
    $('#workflowSteps').show();
    renderWorkflowSteps(data);
    
    // Update initiator avatar
    if (data.requestedBy && data.requestedBy.name) {
      $('#initiatorAvatar span').text(data.requestedBy.name.charAt(0).toUpperCase());
      $('#initiatorAvatar').attr('title', `Started by ${data.requestedBy.name}`);
    }
    
    // Update message
    updateWorkflowMessage(data);
    
    // Show generate payroll section if approved
    if (data.canGeneratePayroll) {
      $('#generatePayrollSection').show();
      $('#workflowActions').hide();
    } else {
      $('#generatePayrollSection').hide();
    }
  }

  function renderWorkflowSteps(data) {
    const stepsHtml = data.steps.map((step, index) => {
      const stepClass = getStepClass(step, data.currentStep);
      const statusClass = `status-${step.status}`;
      
      return `
        <div class="position-relative">
          <div class="workflow-step ${stepClass}" data-step="${step.stepNumber}">
            <div class="d-flex align-items-start justify-content-between">
              <div class="d-flex align-items-start flex-grow-1">
                <div class="step-number ${stepClass}">${step.stepNumber}</div>
                <div class="flex-grow-1">
                  <div class="step-title">${step.role.toUpperCase()} Approval</div>
                  <div class="step-description">${getStepDescription(step.role)}</div>
                  
                  ${step.approvedAt ? `
                    <div class="step-meta">
                      <i class="far fa-clock me-1"></i>
                      ${moment(step.approvedAt).format('DD MMM YYYY, HH:mm')}
                      ${step.approvedBy && step.approvedBy.name ? `
                        <span class="ms-2">
                          <i class="fas fa-user me-1"></i>
                          ${step.approvedBy.name}
                        </span>
                      ` : ''}
                    </div>
                  ` : step.status === 'pending' ? `
                    <div class="step-meta">
                      <i class="fas fa-clock me-1"></i>
                      Waiting for approval
                    </div>
                  ` : ''}
                  
                  ${step.status === 'rejected' ? `
                    <div class="step-meta">
                      <i class="fas fa-times-circle me-1"></i>
                      Step rejected
                    </div>
                  ` : ''}
                </div>
              </div>
              <div>
                <span class="step-status ${statusClass}">${step.status}</span>
              </div>
            </div>
          </div>
          ${index < 2 ? `<div class="workflow-connector ${step.status === 'approved' ? 'completed' : ''}"></div>` : ''}
        </div>
      `;
    }).join('');
    
    $('#workflowSteps').html(stepsHtml);
  }

  function getStepClass(step, currentStep) {
    if (step.status === 'approved') return 'completed';
    if (step.status === 'rejected') return 'rejected';
    if (step.status === 'pending' && step.stepNumber === currentStep) return 'in-progress';
    return '';
  }

  function getStepDescription(role) {
    const descriptions = {
      'hr': 'Human Resources verification',
      'employee': 'Employee representative review',
      'admin': 'Final administrative approval'
    };
    return descriptions[role] || 'Approval required';
  }

  function updateWorkflowMessage(data) {
    if (data.status === 'rejected') {
      $('#messageTitle').text('Workflow Rejected');
      $('#messageText').text('The workflow has been rejected. You can start a new workflow.');
      $('#workflowMessage').removeClass('alert-info alert-warning alert-success').addClass('alert-danger');
    } else if (data.status === 'approved') {
      $('#messageTitle').text('Ready for Payroll Generation');
      $('#messageText').text('All approvals are complete! You can now generate payroll for this month.');
      $('#workflowMessage').removeClass('alert-info alert-warning alert-danger').addClass('alert-success');
    } else if (data.status === 'in_progress') {
      const pendingStep = data.steps.find(s => s.status === 'pending');
      $('#messageTitle').text('Workflow in Progress');
      $('#messageText').text(`Waiting for ${pendingStep.role} approval (Step ${data.currentStep} of 3)`);
      $('#workflowMessage').removeClass('alert-info alert-success alert-danger').addClass('alert-warning');
    } else {
      $('#messageTitle').text('Workflow Created');
      $('#messageText').text('The workflow has been created successfully.');
      $('#workflowMessage').removeClass('alert-warning alert-success alert-danger').addClass('alert-info');
    }
  }

  async function checkMyPendingApprovals() {
    if (!currentUser) return;
    
    try {
      const response = await axios.get('/api/workflow/my-approvals', {
        headers: authHeader()
      });
      
      if (response.data.hasPending) {
        $('#workflowActions').show();
        $('#actionMessage').text(`You have a pending ${response.data.myStep.role} approval`);
      } else {
        $('#workflowActions').hide();
      }
    } catch (error) {
      $('#workflowActions').hide();
    }
  }

  async function startWorkflow() {
    try {
      const result = await Swal.fire({
        title: 'Start Payroll Workflow?',
        html: `
          <div class="text-start">
            <p>This will initiate the payroll approval process for:</p>
            <div class="alert alert-info">
              <i class="fas fa-calendar me-2"></i>
              <strong>${moment(currentMonth).format('MMMM YYYY')}</strong>
            </div>
            <p>The workflow requires 3-step approval:</p>
            <ol>
              <li><strong>HR</strong> approval</li>
              <li><strong>Employee</strong> approval</li>
              <li><strong>Admin</strong> approval</li>
            </ol>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Start Workflow',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        const response = await axios.post('/api/workflow/create', {
          month: currentMonth
        }, {
          headers: authHeader()
        });
        
        Swal.fire({
          title: 'Success!',
          text: response.data.message,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
        loadWorkflowStatus(currentMonth);
        loadWorkflowHistory();
      }
    } catch (error) {
      Swal.fire('Error!', error.response?.data?.message || error.message, 'error');
    }
  }

  async function approveStep() {
    try {
      const result = await Swal.fire({
        title: 'Approve This Step?',
        html: `
          <div class="text-center">
            <div class="mb-3">
              <i class="fas fa-check-circle fa-3x text-success"></i>
            </div>
            <p>You are approving the workflow step as <strong>${currentUser.role.toUpperCase()}</strong></p>
            <p class="text-muted small">This action will move the workflow to the next step.</p>
          </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Approve',
        cancelButtonText: 'Cancel',
        input: 'textarea',
        inputLabel: 'Notes (optional)',
        inputPlaceholder: 'Add any notes...',
        inputAttributes: {
          maxlength: 200
        }
      });
      
      if (result.isConfirmed) {
        const response = await axios.post('/api/workflow/approve', {
          notes: result.value
        }, {
          headers: authHeader()
        });
        
        Swal.fire({
          title: 'Approved!',
          text: response.data.message,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
        loadWorkflowStatus(currentMonth);
        checkMyPendingApprovals();
        loadWorkflowHistory();
      }
    } catch (error) {
      Swal.fire('Error!', error.response?.data?.message || error.message, 'error');
    }
  }

  async function rejectStep() {
    try {
      const result = await Swal.fire({
        title: 'Reject This Step?',
        html: `
          <div class="text-center">
            <div class="mb-3">
              <i class="fas fa-times-circle fa-3x text-danger"></i>
            </div>
            <p>You are rejecting the workflow step as <strong>${currentUser.role.toUpperCase()}</strong></p>
            <p class="text-danger"><strong>Warning:</strong> This will stop the entire workflow.</p>
          </div>
        `,
        icon: 'error',
        showCancelButton: true,
        confirmButtonText: 'Yes, Reject',
        cancelButtonText: 'Cancel',
        input: 'textarea',
        inputLabel: 'Reason for rejection',
        inputPlaceholder: 'Please provide a reason...',
        inputAttributes: {
          required: true,
          maxlength: 500
        }
      });
      
      if (result.isConfirmed) {
        if (!result.value.trim()) {
          Swal.fire('Error!', 'Please provide a reason for rejection', 'error');
          return;
        }
        
        const response = await axios.post('/api/workflow/reject', {
          reason: result.value
        }, {
          headers: authHeader()
        });
        
        Swal.fire({
          title: 'Rejected!',
          text: response.data.message,
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
        loadWorkflowStatus(currentMonth);
        checkMyPendingApprovals();
        loadWorkflowHistory();
      }
    } catch (error) {
      Swal.fire('Error!', error.response?.data?.message || error.message, 'error');
    }
  }

  async function generatePayroll() {
    try {
      const month = $('#payrollMonth').val();
      
      if (!month) {
        Swal.fire('Error!', 'Please select a month', 'error');
        return;
      }
      
      // Check if can generate
      const canGenerate = await axios.get(`/api/workflow/can-generate/${month}`, {
        headers: authHeader()
      });
      
      if (!canGenerate.data.canGenerate) {
        Swal.fire('Cannot Generate', canGenerate.data.reason, 'warning');
        return;
      }
      
      const result = await Swal.fire({
        title: 'Generate Payroll?',
        html: `
          <div class="text-start">
            <p>You are about to generate payroll for:</p>
            <div class="alert alert-success">
              <i class="fas fa-calendar me-2"></i>
              <strong>${moment(month).format('MMMM YYYY')}</strong>
            </div>
            <p>This will:</p>
            <ul>
              <li>Process payroll for all active employees</li>
              <li>Calculate salaries, allowances, and deductions</li>
              <li>Mark the workflow as completed</li>
              <li>Generate payroll records</li>
            </ul>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              This action cannot be undone.
            </div>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Generate Payroll',
        cancelButtonText: 'Cancel',
        showLoaderOnConfirm: true,
        preConfirm: async () => {
          try {
            // Show progress
            let progress = 0;
            const interval = setInterval(() => {
              progress += 10;
              if (progress > 90) clearInterval(interval);
              updateProgress(progress);
            }, 200);
            
            const response = await axios.post('/api/workflow/generate-payroll', {
              month: month
            }, {
              headers: authHeader()
            });
            
            clearInterval(interval);
            updateProgress(100);
            
            return response.data;
          } catch (error) {
            Swal.showValidationMessage(
              `Generation failed: ${error.response?.data?.message || error.message}`
            );
          }
        }
      });
      
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Success!',
          html: `
            <div class="text-center">
              <div class="mb-3">
                <i class="fas fa-check-circle fa-3x text-success"></i>
              </div>
              <p>${result.value.message}</p>
              <div class="alert alert-info mt-3">
                <strong>${result.value.payrollCount}</strong> employee records processed
              </div>
            </div>
          `,
          icon: 'success',
          timer: 3000,
          showConfirmButton: false
        });
        
        loadWorkflowStatus(currentMonth);
        loadGeneratedPayrolls();
        loadWorkflowHistory();
        updateProgress(0);
      }
    } catch (error) {
      Swal.fire('Error!', error.response?.data?.message || error.message, 'error');
      updateProgress(0);
    }
  }

  function updateProgress(percentage) {
    $('.progress-bar-inner').css('width', `${percentage}%`);
    $('#progressText').text(
      percentage === 0 ? 'Ready to generate' :
      percentage === 100 ? 'Complete!' :
      `Processing... ${percentage}%`
    );
  }

  async function loadGeneratedPayrolls() {
    try {
      const response = await axios.get('/api/payroll', {
        headers: authHeader(),
        params: { limit: 10 }
      });
      
      payrollData = response.data.payrolls || [];
      renderPayrollTable(payrollData);
    } catch (error) {
      console.error('Error loading payrolls:', error);
      loadWorkflowsWithPayroll();
    }
  }

  function loadWorkflowsWithPayroll() {
    try {
      axios.get('/api/workflow/history', {
        headers: authHeader()
      }).then(response => {
        const payrolls = response.data.history.filter(w => w.payrollGenerated);
        payrollData = payrolls;
        renderPayrollTableFromWorkflows(payrolls);
      });
    } catch (error) {
      console.error('Error loading workflows:', error);
      showNoPayrolls();
    }
  }

  function renderPayrollTable(payrolls) {
    if (payrolls.length === 0) {
      showNoPayrolls();
      return;
    }
    
    $('#payrollCount').text(payrolls.length);
    
    const tbody = payrolls.map((payroll, index) => `
      <tr data-payroll-id="${payroll._id}">
        <td>
          <strong>${moment(payroll.payrollMonth).format('MMM YYYY')}</strong>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <div class="user-avatar me-2">
              ${payroll.processedBy?.name?.charAt(0).toUpperCase() || 'S'}
            </div>
            <div>
              <div class="text-sm fw-semibold">${payroll.processedBy?.name || 'System'}</div>
              <div class="text-xs text-secondary">${payroll.processedBy?.email || ''}</div>
            </div>
          </div>
        </td>
        <td>
          <div class="text-sm">
            ${moment(payroll.createdAt).format('DD MMM')}
            <br>
            <span class="text-secondary text-xs">${moment(payroll.createdAt).format('HH:mm')}</span>
          </div>
        </td>
        <td>
          <span class="badge bg-primary">${payroll.employeeCount || '--'}</span>
        </td>
        <td>
          <strong class="text-sm">${payroll.currency || 'MWK'} ${(payroll.totalAmount || 0).toLocaleString()}</strong>
        </td>
        <td>
          <span class="badge-status badge-${getPayrollStatusClass(payroll.status || 'completed')}">
            ${(payroll.status || 'generated')}
          </span>
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-sm" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-success btn-sm" title="Export">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
    
    $('#payrollsTable tbody').html(tbody);
  }

  function renderPayrollTableFromWorkflows(workflows) {
    if (workflows.length === 0) {
      showNoPayrolls();
      return;
    }
    
    $('#payrollCount').text(workflows.length);
    
    const tbody = workflows.map((workflow, index) => `
      <tr>
        <td>
          <strong>${moment(workflow.month).format('MMM YYYY')}</strong>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <div class="user-avatar me-2">
              ${workflow.generatedBy?.name?.charAt(0).toUpperCase() || 'S'}
            </div>
            <div>
              <div class="text-sm fw-semibold">${workflow.generatedBy?.name || 'System'}</div>
            </div>
          </div>
        </td>
        <td>
          <div class="text-sm">
            ${moment(workflow.generatedAt).format('DD MMM')}
            <br>
            <span class="text-secondary text-xs">${moment(workflow.generatedAt).format('HH:mm')}</span>
          </div>
        </td>
        <td>
          <span class="badge bg-primary">--</span>
        </td>
        <td>
          <strong class="text-sm">--</strong>
        </td>
        <td>
          <span class="badge-status badge-completed">
            Generated
          </span>
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-sm" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
    
    $('#payrollsTable tbody').html(tbody);
  }

  function showNoPayrolls() {
    $('#payrollsTable tbody').html(`
      <tr>
        <td colspan="7" class="text-center py-5">
          <div class="empty-state py-3">
            <i class="fas fa-inbox"></i>
            <h5>No Payrolls Generated</h5>
            <p>Complete a workflow to generate payroll</p>
          </div>
        </td>
      </tr>
    `);
    $('#payrollCount').text('0');
  }

  function getPayrollStatusClass(status) {
    const statusMap = {
      'generated': 'completed',
      'paid': 'paid',
      'pending': 'pending',
      'approved': 'approved',
      'rejected': 'rejected'
    };
    return statusMap[status.toLowerCase()] || 'pending';
  }

  async function loadWorkflowHistory() {
    try {
      const response = await axios.get('/api/workflow/history', {
        headers: authHeader()
      });
      
      const history = response.data.history || [];
      renderWorkflowHistory(history.slice(0, 5));
      updateStats(history);
    } catch (error) {
      console.error('Error loading history:', error);
      $('#workflowHistory').html(`
        <div class="text-center py-3">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span class="text-secondary">Failed to load history</span>
        </div>
      `);
    }
  }

  function renderWorkflowHistory(history) {
    if (history.length === 0) {
      $('#workflowHistory').html(`
        <div class="text-center py-3">
          <i class="fas fa-history text-secondary me-2"></i>
          <span class="text-secondary text-sm">No workflow history</span>
        </div>
      `);
      return;
    }
    
    const historyHtml = history.map(workflow => {
      const statusClass = workflow.status === 'rejected' ? 'rejected' :
                         workflow.status === 'completed' ? 'completed' :
                         workflow.status === 'approved' ? 'completed' :
                         'in-progress';
      
      return `
        <div class="history-item ${statusClass}" data-workflow-id="${workflow._id}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="history-title">${moment(workflow.month).format('MMMM YYYY')}</div>
              <div class="history-meta">
                <i class="far fa-user me-1"></i>
                ${workflow.requestedBy?.name || 'System'}
              </div>
            </div>
            <div>
              <span class="badge bg-${getStatusColor(workflow.status)}">
                ${workflow.status.replace('_', ' ')}
              </span>
            </div>
          </div>
          <div class="history-meta">
            <div class="mb-1">
              <i class="far fa-clock me-1"></i>
              ${moment(workflow.createdAt).fromNow()}
            </div>
            ${workflow.payrollGenerated ? `
              <div class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                Payroll generated
              </div>
            ` : `
              <div>
                <i class="fas fa-spinner me-1"></i>
                ${getWorkflowProgress(workflow)}/3 steps complete
              </div>
            `}
          </div>
        </div>
      `;
    }).join('');
    
    $('#workflowHistory').html(historyHtml);
    
    $('.history-item').click(function() {
      const workflowId = $(this).data('workflow-id');
      viewWorkflowDetails(workflowId);
    });
  }

  function getStatusColor(status) {
    const colors = {
      'completed': 'success',
      'approved': 'success',
      'in_progress': 'warning',
      'pending': 'warning',
      'rejected': 'danger'
    };
    return colors[status] || 'secondary';
  }

  function getWorkflowProgress(workflow) {
    if (!workflow.steps) return 0;
    return workflow.steps.filter(step => step.status === 'approved').length;
  }

  function updateStats(history) {
    const total = history.length;
    const completed = history.filter(w => w.status === 'completed' || w.status === 'approved').length;
    const pending = history.filter(w => w.status === 'in_progress' || w.status === 'pending').length;
    const rejected = history.filter(w => w.status === 'rejected').length;
    
    animateCounter('#totalWorkflows', total);
    animateCounter('#completedWorkflows', completed);
    animateCounter('#pendingWorkflows', pending);
    animateCounter('#rejectedWorkflows', rejected);
  }

  function animateCounter(selector, target) {
    const element = $(selector);
    const current = parseInt(element.text()) || 0;
    
    if (current === target) return;
    
    let start = current;
    const increment = target > start ? 1 : -1;
    const duration = 1000;
    const stepTime = Math.abs(Math.floor(duration / (target - start)));
    
    const timer = setInterval(() => {
      start += increment;
      element.text(start);
      
      if (start === target) {
        clearInterval(timer);
      }
    }, stepTime);
  }

  async function loadMonthList() {
    try {
      const months = [];
      for (let i = 0; i < 12; i++) {
        const month = moment().subtract(i, 'months').format('YYYY-MM');
        months.push({
          value: month,
          label: moment(month).format('MMMM YYYY')
        });
      }
      
      const monthListHtml = months.map(month => `
        <li>
          <a class="dropdown-item month-item" href="#" data-month="${month.value}">
            ${month.label}
            ${month.value === currentMonth ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
          </a>
        </li>
      `).join('');
      
      $('#monthList').html(monthListHtml);
    } catch (error) {
      console.error('Error loading month list:', error);
    }
  }

  function showLoading(selector, message = 'Loading...') {
    $(selector).html(`
      <div class="text-center py-4">
        <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
        <div class="text-secondary text-sm">${message}</div>
      </div>
    `);
  }

  function showError(message) {
    $('#workflowMessage').html(`
      <div class="d-flex align-items-start">
        <i class="fas fa-exclamation-triangle me-2 mt-1 text-danger"></i>
        <div>
          <div class="fw-semibold mb-1 text-danger">Error</div>
          <div class="text-sm">${message}</div>
        </div>
      </div>
    `).removeClass('alert-info alert-warning alert-success').addClass('alert-danger');
  }

  function refreshData() {
    loadWorkflowStatus(currentMonth);
    loadGeneratedPayrolls();
    loadWorkflowHistory();
    
    Swal.fire({
      title: 'Refreshed!',
      text: 'Data has been refreshed',
      icon: 'success',
      timer: 1500,
      showConfirmButton: false
    });
  }

  function viewReports() {
    Swal.fire({
      title: 'Reports',
      text: 'Reports feature coming soon!',
      icon: 'info',
      confirmButtonText: 'OK'
    });
  }

  function showHelp() {
    Swal.fire({
      title: 'Help & Support',
      html: `
        <div class="text-start">
          <h6>Payroll Workflow Guide</h6>
          <ol>
            <li><strong>Start Workflow:</strong> Any user can start a workflow for a month</li>
            <li><strong>3-Step Approval:</strong> HR → Employee → Admin must approve</li>
            <li><strong>Generate Payroll:</strong> After all approvals, generate payroll</li>
            <li><strong>View History:</strong> Check past workflows and generated payrolls</li>
          </ol>
          <hr>
          <div class="small text-muted">
            <i class="fas fa-question-circle me-1"></i>
            For additional help, contact support@example.com
          </div>
        </div>
      `,
      icon: 'info',
      confirmButtonText: 'Got it!'
    });
  }

  function viewAllHistory() {
    Swal.fire({
      title: 'All History',
      text: 'Full history view coming soon!',
      icon: 'info',
      confirmButtonText: 'OK'
    });
  }

  function viewWorkflowDetails(workflowId) {
    Swal.fire({
      title: 'Workflow Details',
      text: 'Detailed workflow view coming soon!',
      icon: 'info',
      confirmButtonText: 'OK'
    });
  }
  </script>
</body>
</html>


