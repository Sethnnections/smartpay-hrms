<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Positions Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="/css/positions.css">
    
    <!-- Select2 for better dropdowns -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'positions' }) %>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <%- include('./partials/header', { 
            title: 'Positions Management', 
            user: typeof user !== 'undefined' ? user : { name: 'User', email: '', avatar: 'U' } 
        }) %>

        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <p class="text-muted">Manage and track all positions within your organization</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPositionModal" id="addPositionBtn">
                            <i class="fas fa-plus me-2"></i>Add Position
                        </button>
                    </div>
                </div>

                <!-- Positions Stats -->
                <div class="row mb-4" id="positionsStats">
                    <!-- Stats will be loaded here -->
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="filterForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Name, code or description">
                            </div>
                            <div class="col-md-2">
                                <label for="departmentFilter" class="form-label">Department</label>
                                <select class="form-select" id="departmentFilter">
                                    <option value="">All Departments</option>
                                    <!-- Departments will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="gradeFilter" class="form-label">Grade</label>
                                <select class="form-select" id="gradeFilter">
                                    <option value="">All Grades</option>
                                    <!-- Grades will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="true">Active Only</option>
                                    <option value="false">Include Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="vacancyFilter" class="form-label">Vacancies</label>
                                <select class="form-select" id="vacancyFilter">
                                    <option value="">All Positions</option>
                                    <option value="true">With Vacancies</option>
                                </select>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Positions Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="positionsTable">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Department</th>
                                        <th>Grade</th>
                                        <th>Capacity</th>
                                        <th>Salary</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTableBody">
                                    <!-- Positions will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be loaded here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Position Modal -->
    <div class="modal fade" id="addPositionModal" tabindex="-1" aria-labelledby="addPositionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPositionModalLabel">Add New Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addPositionForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="positionName" class="form-label">Position Name*</label>
                                <input type="text" class="form-control" id="positionName" name="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="positionCode" class="form-label">Position Code</label>
                                <input type="text" class="form-control" id="positionCode" name="code">
                            </div>
                            <div class="col-md-6">
                                <label for="positionDepartment" class="form-label">Department*</label>
                                <select class="form-select" id="positionDepartment" name="departmentId" required>
                                    <option value="">Select Department</option>
                                    <!-- Departments will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="positionGrade" class="form-label">Grade*</label>
                                <select class="form-select" id="positionGrade" name="gradeId" required>
                                    <option value="">Select Grade</option>
                                    <!-- Grades will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="positionReportingTo" class="form-label">Reports To</label>
                                <select class="form-select" id="positionReportingTo" name="reportingTo">
                                    <option value="">Select Reporting Position</option>
                                    <!-- Positions will be loaded here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="positionJobType" class="form-label">Job Type*</label>
                                <select class="form-select" id="positionJobType" name="jobType" required>
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                    <option value="temporary">Temporary</option>
                                    <option value="intern">Intern</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="positionCapacity" class="form-label">Total Capacity*</label>
                                <input type="number" class="form-control" id="positionCapacity" name="capacity.total" min="1" value="1" required>
                            </div>
                            <div class="col-md-6">
                                <label for="positionStatus" class="form-label">Status*</label>
                                <select class="form-select" id="positionStatus" name="status" required>
                                    <option value="active">Active</option>
                                    <option value="frozen">Frozen</option>
                                    <option value="under_review">Under Review</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="positionDescription" class="form-label">Description*</label>
                                <textarea class="form-control" id="positionDescription" name="description" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Responsibilities</label>
                                <div id="responsibilitiesContainer">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control responsibility-input" name="responsibilities[]">
                                        <button type="button" class="btn btn-outline-danger remove-responsibility" disabled>
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addResponsibility">
                                    <i class="fas fa-plus me-1"></i>Add Responsibility
                                </button>
                            </div>
                            <div class="col-12">
                                <div class="accordion" id="requirementsAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRequirements">
                                                <strong>Requirements</strong>
                                            </button>
                                        </h2>
                                        <div id="collapseRequirements" class="accordion-collapse collapse show" data-bs-parent="#requirementsAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="positionEducationMin" class="form-label">Minimum Education*</label>
                                                        <select class="form-select" id="positionEducationMin" name="requirements.education.minimum" required>
                                                            <option value="high_school">High School</option>
                                                            <option value="diploma">Diploma</option>
                                                            <option value="bachelor" selected>Bachelor's Degree</option>
                                                            <option value="master">Master's Degree</option>
                                                            <option value="phd">PhD</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="positionEducationPref" class="form-label">Preferred Education</label>
                                                        <select class="form-select" id="positionEducationPref" name="requirements.education.preferred">
                                                            <option value="">Not Specified</option>
                                                            <option value="high_school">High School</option>
                                                            <option value="diploma">Diploma</option>
                                                            <option value="bachelor">Bachelor's Degree</option>
                                                            <option value="master">Master's Degree</option>
                                                            <option value="phd">PhD</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="positionEducationField" class="form-label">Education Field</label>
                                                        <input type="text" class="form-control" id="positionEducationField" name="requirements.education.field">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="positionExpMin" class="form-label">Minimum Experience (years)*</label>
                                                        <input type="number" class="form-control" id="positionExpMin" name="requirements.experience.minimum" min="0" value="0" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="positionExpPref" class="form-label">Preferred Experience (years)</label>
                                                        <input type="number" class="form-control" id="positionExpPref" name="requirements.experience.preferred" min="0" value="0">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="positionExpType" class="form-label">Experience Type</label>
                                                        <select class="form-select" id="positionExpType" name="requirements.experience.type">
                                                            <option value="relevant" selected>Relevant</option>
                                                            <option value="any">Any</option>
                                                            <option value="management">Management</option>
                                                            <option value="technical">Technical</option>
                                                            <option value="leadership">Leadership</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Position</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Position Modal -->
    <div class="modal fade" id="editPositionModal" tabindex="-1" aria-labelledby="editPositionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPositionModalLabel">Edit Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editPositionForm">
                    <input type="hidden" id="editPositionId" name="id">
                    <div class="modal-body">
                        <!-- Same content as add modal, will be populated dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Position Details Modal -->
    <div class="modal fade" id="positionDetailsModal" tabindex="-1" aria-labelledby="positionDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="positionDetailsModalLabel">Position Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="positionDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Capacity Update Modal -->
    <div class="modal fade" id="capacityModal" tabindex="-1" aria-labelledby="capacityModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="capacityModalLabel">Update Position Capacity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="capacityForm">
                    <input type="hidden" id="capacityPositionId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="capacityChange" class="form-label">Change in Filled Positions</label>
                            <input type="number" class="form-control" id="capacityChange" min="-10" max="10" value="1">
                            <small class="text-muted">Positive number to add, negative to remove</small>
                        </div>
                        <div class="alert alert-info">
                            Current capacity: <span id="currentCapacityDisplay"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Capacity</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deactivate Position Modal -->
    <div class="modal fade" id="deactivatePositionModal" tabindex="-1" aria-labelledby="deactivatePositionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="deactivatePositionModalLabel">Deactivate Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deactivatePositionForm">
                    <input type="hidden" id="deactivatePositionId">
                    <div class="modal-body">
                        <p>Are you sure you want to deactivate this position?</p>
                        <div class="alert alert-danger" id="deactivatePositionWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="deactivateWarningText"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Deactivate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hierarchy Modal -->
    <div class="modal fade" id="hierarchyModal" tabindex="-1" aria-labelledby="hierarchyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="hierarchyModalLabel">Position Hierarchy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="hierarchyChart">
                        <!-- Hierarchy chart will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statisticsModalLabel">Position Statistics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="card-title">Capacity Overview</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <div>
                                            <h5 id="totalCapacityStat">0</h5>
                                            <small class="text-muted">Total Positions</small>
                                        </div>
                                        <div>
                                            <h5 id="filledCapacityStat">0</h5>
                                            <small class="text-muted">Filled</small>
                                        </div>
                                        <div>
                                            <h5 id="vacantCapacityStat">0</h5>
                                            <small class="text-muted">Vacant</small>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" id="filledProgress" role="progressbar" style="width: 0%"></div>
                                        <div class="progress-bar bg-warning" id="vacantProgress" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="card-title">Employee Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <div>
                                            <h5 id="activeEmployeesStat">0</h5>
                                            <small class="text-muted">Active</small>
                                        </div>
                                        <div>
                                            <h5 id="totalEmployeesStat">0</h5>
                                            <small class="text-muted">Total</small>
                                        </div>
                                        <div>
                                            <h5 id="avgTenureStat">0</h5>
                                            <small class="text-muted">Avg Tenure (months)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title">Salary Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Component</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="salaryStatsBody">
                                                <!-- Salary stats will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/positions.js"></script>
</body>
</html>