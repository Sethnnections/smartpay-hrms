<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS - Positions Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.4.8/sweetalert2.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="/css/positions.css">
    
    <!-- Select2 for better dropdowns -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <%- include('./partials/sidebar', { currentPage: 'positions' }) %>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <%- include('./partials/header', { 
            title: 'Positions Management', 
            user: typeof user !== 'undefined' ? user : { name: 'User', email: '', avatar: 'U' } 
        }) %>

        <!-- Page Content -->
        <main class="dashboard-content">
            <div class="container-fluid px-4">
                <!-- Alerts Container -->
                <div id="alertsContainer"></div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="page-title">Positions</h1>
                            <p class="text-muted">Manage and track all positions within your organization</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPositionModal" id="addPositionBtn">
                            <i class="fas fa-plus me-2"></i>Add Position
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Name or code...">
                            </div>
                            <div class="col-md-2">
                                <label for="filterDepartment" class="form-label">Department</label>
                                <select class="form-select select2" id="filterDepartment">
                                    <option value="">All Departments</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filterGrade" class="form-label">Grade</label>
                                <select class="form-select select2" id="filterGrade">
                                    <option value="">All Grades</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-4 pt-2">
                                    <input class="form-check-input" type="checkbox" id="filterVacancies">
                                    <label class="form-check-label" for="filterVacancies">Has Vacancies</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-4 pt-2">
                                    <input class="form-check-input" type="checkbox" id="filterActive" checked>
                                    <label class="form-check-label" for="filterActive">Active Only</label>
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-primary me-2" id="applyFilters">Apply</button>
                                <button class="btn btn-outline-secondary" id="resetFilters">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Positions Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">All Positions</h5>
                        <div class="text-muted">Showing <span id="positionsCount">0</span> positions</div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="positionsTable">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Grade</th>
                                        <th>Total</th>
                                        <th>Filled</th>
                                        <th>Vacancy</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Positions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Position Modal -->
    <div class="modal fade" id="addPositionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addPositionForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Position Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="code" class="form-label">Position Code</label>
                                <input type="text" class="form-control" id="code" required>
                            </div>
                            <div class="col-md-6">
                                <label for="departmentId" class="form-label">Department</label>
                                <select class="form-select select2" id="departmentId" required>
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="gradeId" class="form-label">Grade</label>
                                <select class="form-select select2" id="gradeId" required>
                                    <option value="">Select Grade</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reportingTo" class="form-label">Reports To</label>
                                <select class="form-select select2" id="reportingTo">
                                    <option value="">Select Position (Optional)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="jobType" class="form-label">Job Type</label>
                                <select class="form-select" id="jobType" required>
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                    <option value="temporary">Temporary</option>
                                    <option value="intern">Intern</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="capacityTotal" class="form-label">Total Capacity</label>
                                <input type="number" class="form-control" id="capacityTotal" min="1" value="1" required>
                            </div>
                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label for="responsibilities" class="form-label">Responsibilities (One per line)</label>
                                <textarea class="form-control" id="responsibilities" rows="3"></textarea>
                            </div>
                            
                            <!-- Requirements Section -->
                            <div class="col-12 mt-3">
                                <h6 class="border-bottom pb-2">Requirements</h6>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="educationMinimum" class="form-label">Minimum Education</label>
                                <select class="form-select" id="educationMinimum" required>
                                    <option value="high_school">High School</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="bachelor" selected>Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="phd">PhD</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="educationPreferred" class="form-label">Preferred Education</label>
                                <select class="form-select" id="educationPreferred">
                                    <option value="">Not Specified</option>
                                    <option value="high_school">High School</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="bachelor">Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="phd">PhD</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="educationField" class="form-label">Field of Study</label>
                                <input type="text" class="form-control" id="educationField">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="experienceMinimum" class="form-label">Minimum Experience (Years)</label>
                                <input type="number" class="form-control" id="experienceMinimum" min="0" value="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="experiencePreferred" class="form-label">Preferred Experience (Years)</label>
                                <input type="number" class="form-control" id="experiencePreferred" min="0">
                            </div>
                            <div class="col-md-4">
                                <label for="experienceType" class="form-label">Experience Type</label>
                                <select class="form-select" id="experienceType">
                                    <option value="relevant" selected>Relevant</option>
                                    <option value="any">Any</option>
                                    <option value="management">Management</option>
                                    <option value="technical">Technical</option>
                                    <option value="leadership">Leadership</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Position</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Position Modal -->
    <div class="modal fade" id="editPositionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editPositionForm">
                    <input type="hidden" id="editPositionId">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editName" class="form-label">Position Name</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editCode" class="form-label">Position Code</label>
                                <input type="text" class="form-control" id="editCode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editDepartmentId" class="form-label">Department</label>
                                <select class="form-select select2" id="editDepartmentId" required>
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editGradeId" class="form-label">Grade</label>
                                <select class="form-select select2" id="editGradeId" required>
                                    <option value="">Select Grade</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editReportingTo" class="form-label">Reports To</label>
                                <select class="form-select select2" id="editReportingTo">
                                    <option value="">Select Position (Optional)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editJobType" class="form-label">Job Type</label>
                                <select class="form-select" id="editJobType" required>
                                    <option value="full-time">Full-time</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="contract">Contract</option>
                                    <option value="temporary">Temporary</option>
                                    <option value="intern">Intern</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editCapacityTotal" class="form-label">Total Capacity</label>
                                <input type="number" class="form-control" id="editCapacityTotal" min="1" value="1" required>
                            </div>
                            <div class="col-12">
                                <label for="editDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editDescription" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label for="editResponsibilities" class="form-label">Responsibilities (One per line)</label>
                                <textarea class="form-control" id="editResponsibilities" rows="3"></textarea>
                            </div>
                            
                            <!-- Requirements Section -->
                            <div class="col-12 mt-3">
                                <h6 class="border-bottom pb-2">Requirements</h6>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="editEducationMinimum" class="form-label">Minimum Education</label>
                                <select class="form-select" id="editEducationMinimum" required>
                                    <option value="high_school">High School</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="bachelor" selected>Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="phd">PhD</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editEducationPreferred" class="form-label">Preferred Education</label>
                                <select class="form-select" id="editEducationPreferred">
                                    <option value="">Not Specified</option>
                                    <option value="high_school">High School</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="bachelor">Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="phd">PhD</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="editEducationField" class="form-label">Field of Study</label>
                                <input type="text" class="form-control" id="editEducationField">
                            </div>
                            
                            <div class="col-md-4">
                                <label for="editExperienceMinimum" class="form-label">Minimum Experience (Years)</label>
                                <input type="number" class="form-control" id="editExperienceMinimum" min="0" value="0" required>
                            </div>
                            <div class="col-md-4">
                                <label for="editExperiencePreferred" class="form-label">Preferred Experience (Years)</label>
                                <input type="number" class="form-control" id="editExperiencePreferred" min="0">
                            </div>
                            <div class="col-md-4">
                                <label for="editExperienceType" class="form-label">Experience Type</label>
                                <select class="form-select" id="editExperienceType">
                                    <option value="relevant" selected>Relevant</option>
                                    <option value="any">Any</option>
                                    <option value="management">Management</option>
                                    <option value="technical">Technical</option>
                                    <option value="leadership">Leadership</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Position</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Position Details Modal -->
    <div class="modal fade" id="positionDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Position Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="positionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#position-details" type="button" role="tab">Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="hierarchy-tab" data-bs-toggle="tab" data-bs-target="#position-hierarchy" type="button" role="tab">Hierarchy</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#position-statistics" type="button" role="tab">Statistics</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content p-3 border border-top-0 rounded-bottom" id="positionTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Basic Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Name:</strong> <span id="positionName"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Code:</strong> <span id="positionCode"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Department:</strong> <span id="positionDepartment"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Grade:</strong> <span id="positionGrade"></span>
                                            </div>
                                            <div>
                                                <strong>Status:</strong> <span id="positionStatus"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Capacity</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <strong>Total:</strong> <span id="positionCapacityTotal"></span>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <strong>Filled:</strong> <span id="positionCapacityFilled"></span>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <strong>Vacant:</strong> <span id="positionCapacityVacant"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <strong>Vacancy Rate:</strong> <span id="positionVacancyRate"></span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <strong>Occupancy Rate:</strong> <span id="positionOccupancyRate"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Compensation</h6>
                                        </div>
                                        <div class="card-body" id="positionSalary">
                                            <!-- Salary info will be loaded here -->
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Requirements</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <h6>Education</h6>
                                                <div id="positionEducation"></div>
                                            </div>
                                            <div>
                                                <h6>Experience</h6>
                                                <div id="positionExperience"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Description</h6>
                                </div>
                                <div class="card-body">
                                    <div id="positionDescription"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Details Tab -->
                        <div class="tab-pane fade" id="position-details" role="tabpanel">
                            <p>Detailed position information will be loaded here</p>
                        </div>
                        
                        <!-- Hierarchy Tab -->
                        <div class="tab-pane fade" id="position-hierarchy" role="tabpanel">
                            <div id="positionHierarchy">
                                <!-- Hierarchy will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Statistics Tab -->
                        <div class="tab-pane fade" id="position-statistics" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Key Metrics</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Total Capacity:</strong> <span id="statCapacityTotal"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Filled Positions:</strong> <span id="statCapacityFilled"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Vacant Positions:</strong> <span id="statCapacityVacant"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Occupancy Rate:</strong> <span id="statOccupancyRate"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Vacancy Rate:</strong> <span id="statVacancyRate"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Active Employees:</strong> <span id="statActiveEmployees"></span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Total Employees (All Time):</strong> <span id="statTotalEmployees"></span>
                                            </div>
                                            <div>
                                                <strong>Average Tenure (Months):</strong> <span id="statAvgTenure"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Capacity Visualization</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="statsChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.4.8/sweetalert2.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/positions.js"></script>
</body>
</html>